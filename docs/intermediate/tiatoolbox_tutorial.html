
<!DOCTYPE html>


<html lang="ko" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta property="article:modified_time" content="2024-06-09T15:35:40+00:00" /><meta property="og:title" content="Pytorch와 TIAToolbox를 사용한 전체 슬라이드 이미지(Whole Slide Image) 분류" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tutorials.pytorch.kr/intermediate/tiatoolbox_tutorial.html" />
<meta property="og:site_name" content="PyTorch Tutorials KR" />
<meta property="og:description" content="번역: 박주환 개요: 본 튜토리얼에서는 TIAToolbox를 사용한 PyTorch 모델을 통해 전체 슬라이드 이미지들(Whole Slide Images, WSIs)을 분류하는 방법을 알아보겠습니다. WSI란 수술이나 생검을 통해 채취된 인간 조직 샘플의 이미지이며, 이러한 이미지는 전문 스캐너를 이용해 스캔 됩니다. 이 데이터는 병리학자와 전산 병리학자들이 종양 성장에 대한 이해를 높이고 환자 치료를 개선하기 위해 암과 같은 질병을 미시적 수준에서 연구 하는데 사용됩니다. WSIs를 처리하는 것이 어려운 이유는 엄청난 크기 때..." />
<meta property="og:image" content="https://tutorials.pytorch.kr/_static/logos/logo-kr-sm-dark.png" />
<meta property="og:image:alt" content="PyTorch Tutorials KR" />
<meta name="description" content="번역: 박주환 개요: 본 튜토리얼에서는 TIAToolbox를 사용한 PyTorch 모델을 통해 전체 슬라이드 이미지들(Whole Slide Images, WSIs)을 분류하는 방법을 알아보겠습니다. WSI란 수술이나 생검을 통해 채취된 인간 조직 샘플의 이미지이며, 이러한 이미지는 전문 스캐너를 이용해 스캔 됩니다. 이 데이터는 병리학자와 전산 병리학자들이 종양 성장에 대한 이해를 높이고 환자 치료를 개선하기 위해 암과 같은 질병을 미시적 수준에서 연구 하는데 사용됩니다. WSIs를 처리하는 것이 어려운 이유는 엄청난 크기 때..." />
<meta property="og:ignore_canonical" content="true" />

    <title>Pytorch와 TIAToolbox를 사용한 전체 슬라이드 이미지(Whole Slide Image) 분류 &#8212; 파이토치 한국어 튜토리얼 (PyTorch tutorials in Korean)</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=536c50fe" />
    <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=4d2595e5" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/katex-math.css?v=91adb8b6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/pytorch_theme.css?v=c326296f" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=097efa9c" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom2.css?v=b169ea90" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=725a5b95"></script>
    <script src="../_static/doctools.js?v=92e14aea"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/translations.js?v=b5f768d8"></script>
    <script src="../_static/katex.min.js?v=be8ff15f"></script>
    <script src="../_static/auto-render.min.js?v=ad136472"></script>
    <script src="../_static/katex_autorenderer.js?v=bebc588a"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'intermediate/tiatoolbox_tutorial';</script>
    <link rel="canonical" href="https://tutorials.pytorch.kr/intermediate/tiatoolbox_tutorial.html" />
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="색인" href="../genindex.html" />
    <link rel="search" title="검색" href="../search.html" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="ko"/>
    <meta name="docbuild:last-update" content="2024년 06월 09일"/>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
<script>
  if (window.location.hostname === 'docs.pytorch.org' || window.location.hostname === 'docs-preview.pytorch.org') {
    const script = document.createElement('script');
    script.src = 'https://cmp.osano.com/16A0DbT9yDNIaQkvZ/31b1b91a-e0b6-47ea-bde2-7f2bd13dbe5c/osano.js?variant=one';
    document.head.appendChild(script);
  }
</script>
<script>
  // Cookie banner for non-LF projects
  document.addEventListener('DOMContentLoaded', function () {
    // Hide cookie banner on local environments and LF owned docs
    if (window.location.hostname === 'localhost' ||
      window.location.hostname === '0.0.0.0' ||
      window.location.hostname === '127.0.0.1' ||
      window.location.hostname === 'docs.pytorch.org' ||
      window.location.hostname === 'docs-preview.pytorch.org' ||
      window.location.hostname.startsWith('192.168.')) {
      const banner = document.querySelector('.cookie-banner-wrapper');
      if (banner) {
        banner.style.display = 'none';
      }
    }
  });
</script>
<!-- Conditional CSS for header and footer height adjustment -->

<link rel="stylesheet" type="text/css" href="../_static/css/theme.css" crossorigin="anonymous">
<script type="text/javascript" src="../_static/js/theme.js"></script>
<script type="text/javascript" src="../_static/js/dropdown-menu.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&family=Nanum+Gothic+Coding:wght@400;700&family=Montserrat:wght@300;400&display=swap" rel="stylesheet">
<meta property="og:image" content="../_static/img/pytorch_seo.png" />
<link rel="stylesheet" href="../_static/webfonts/all.min.css" crossorigin="anonymous">
<meta http-equiv="Content-Security-Policy"
  content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval' blob:;">
<meta name="pytorch_project" content="tutorials">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=G-LZRD6GXDLF" height="0" width="0"
    style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<!-- Google Tag Manager -->
<script>(function (w, d, s, l, i) {
    w[l] = w[l] || []; w[l].push({
      'gtm.start':
        new Date().getTime(), event: 'gtm.js'
    }); var f = d.getElementsByTagName(s)[0],
      j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
        'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
    j.onload = function () {
      window.dispatchEvent(new Event('gtm_loaded'));
      console.log('GTM loaded successfully');
    };
  })(window, document, 'script', 'dataLayer', 'G-LZRD6GXDLF');
</script>
<!-- End Google Tag Manager -->
<!-- Facebook Pixel Code -->
<script>
  !function (f, b, e, v, n, t, s) {
    if (f.fbq) return; n = f.fbq = function () {
      n.callMethod ?
        n.callMethod.apply(n, arguments) : n.queue.push(arguments)
    };
    if (!f._fbq) f._fbq = n; n.push = n; n.loaded = !0; n.version = '2.0';
    n.queue = []; t = b.createElement(e); t.async = !0;
    t.src = v; s = b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t, s)
  }(window, document, 'script',
    'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '243028289693773');
  fbq('track', 'PageView');
</script>
<script>
  document.documentElement.setAttribute('data-version', 'v2.8.0+cu128');
</script>
<noscript>
  <img height="1" width="1" src="https://www.facebook.com/tr?id=243028289693773&ev=PageView&noscript=1" />
</noscript>
<script>
  function gtag() {
    window.dataLayer.push(arguments);
  }
</script>
<!-- End Facebook Pixel Code -->
<!-- Script to Fix scrolling -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Fix anchor scrolling
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          const headerHeight =
            (document.querySelector('.header-holder') ? document.querySelector('.header-holder').offsetHeight : 0) +
            (document.querySelector('.bd-header') ? document.querySelector('.bd-header').offsetHeight : 0) + 20;

          const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - headerHeight;
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });

          // Update URL hash without scrolling
          history.pushState(null, null, '#' + targetId);
        }
      });
    });
  });
</script>

<script async src="https://cse.google.com/cse.js?cx=e65585f8c3ea1440e"></script>


  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="ko"/>
    <meta name="docbuild:last-update" content="2024년 06월 09일"/>

  </head>

<body data-feedback-url="https://github.com/PyTorchKorea/tutorials-kr" class="pytorch-body">
  
    <div class="container-fluid header-holder tutorials-header" id="header-holder">
   <div class="header-container-wrapper">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.kr/" aria-label="PyTorchKR"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="learnDropdownButton" data-toggle="learn-dropdown" class="learn-dropdown">
              <a class="with-down-arrow">
                <span>배우기</span>
              </a>
              <div class="learn-dropdown-menu dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.kr/get-started/locally/">
                  <span class="dropdown-title">PyTorch 시작하기</span>
                </a>
                <a class="nav-dropdown-item" href="https://tutorials.pytorch.kr/beginner/basics/intro.html">
                  <span class="dropdown-title">기본 익히기</span>
                </a>
                <a class="nav-dropdown-item" href="https://tutorials.pytorch.kr/" target="_self">
                  <span class="dropdown-title">한국어 튜토리얼</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.kr/hub/">
                  <span class="dropdown-title">한국어 모델 허브</span>
                </a>
                <a class="nav-dropdown-item" href="https://docs.pytorch.org/tutorials/" target="_blank">
                  <span class="dropdown-title">Official Tutorials</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <a href="https://pytorch.kr/blog/">
              <span>블로그</span>
            </a>
          </li>

          <li class="main-menu-item">
          <div id="docsDropdownButton" data-toggle="docs-dropdown" class="docs-dropdown">
              <a class="with-down-arrow">
              <span>문서</span>
              </a>
              <div class="docs-dropdown-menu dropdown-menu">
                <a class="nav-dropdown-item" href="https://docs.pytorch.org/docs/" target="_blank">
                  <span class="dropdown-title">PyTorch API</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.kr/domains/">
                  <span class="dropdown-title">Domain API 소개</span>
                </a>
                <a class="nav-dropdown-item" href="https://tutorials.pytorch.kr/" target="_self">
                  <span class="dropdown-title">한국어 튜토리얼</span>
                </a>
                <a class="nav-dropdown-item" href="https://docs.pytorch.org/tutorials/" target="_blank">
                  <span class="dropdown-title">Official Tutorials</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
          <div id="communityDropdownButton" data-toggle="community-dropdown" class="community-dropdown">
              <a class="with-down-arrow">
              <span>커뮤니티</span>
              </a>
              <div class="community-dropdown-menu dropdown-menu">
                <a class="nav-dropdown-item" href="https://discuss.pytorch.kr/" target="_self">
                  <span class="dropdown-title">한국어 커뮤니티</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.kr/resources/">
                  <span class="dropdown-title">개발자 정보</span>
                </a>
                <a class="nav-dropdown-item" href="https://landscape.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Landscape</span>
                </a>
              </div>
            </div>
          </li>

        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu">
        <i class="fa-solid fa-ellipsis"></i>
      </a>
    </div>
  </div>
 </div>

 <!-- Begin Mobile Menu -->

<div class="mobile-main-menu">
  <div class="container-fluid">
    <div class="header-container-wrapper">
      <div class="mobile-main-menu-header-container">
        <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu">
          <i class="fa-solid fa-xmark"></i>
        </a>
      </div>
    </div>
  </div>

  <div class="mobile-main-menu-links-container">
    <div class="main-menu">
      <ul>
         <li class="resources-mobile-menu-title">
           <a>배우기</a>
         </li>
         <ul class="resources-mobile-menu-items">
           <li>
             <a href="https://pytorch.kr/get-started/locally/">PyTorch 시작하기</a>
           </li>
           <li>
             <a href="https://tutorials.pytorch.kr/beginner/basics/intro.html">기본 익히기</a>
           </li>
           <li>
             <a href="https://tutorials.pytorch.kr/">한국어 튜토리얼</a>
           </li>
           <li>
             <a href="https://pytorch.kr/hub/">한국어 모델 허브</a>
           </li>
           <li>
             <a href="https://docs.pytorch.org/tutorials/" target="_blank">Official Tutorials</a>
           </li>
        </ul>
         <li class="resources-mobile-menu-title">
           <a href="https://pytorch.kr/blog/">블로그</a>
         </li>
         <li class="resources-mobile-menu-title">
           <a>문서</a>
         </li>
         <ul class="resources-mobile-menu-items">
          <li>
            <a href="https://docs.pytorch.org/docs/" target="_blank">PyTorch API</a>
          </li>
          <li>
            <a href="https://pytorch.kr/domains/">Domain API 소개</a>
          </li>
          <li>
            <a href="https://tutorials.pytorch.kr/">한국어 튜토리얼</a>
          </li>
          <li>
            <a href="https://docs.pytorch.org/tutorials/" target="_blank">Official Tutorials</a>
          </li>
        </ul>
        <li class="resources-mobile-menu-title">
          <a>커뮤니티</a>
        </li>
         <ul class="resources-mobile-menu-items">
          <li>
            <a href="https://discuss.pytorch.kr/">한국어 커뮤니티</a>
          </li>
          <li>
            <a href="https://pytorch.kr/resources/">개발자 정보</a>
          </li>
          <li>
            <a href="https://landscape.pytorch.org/" target="_blank">Landscape</a>
          </li>
        </ul>
      </ul>
    </div>
  </div>
</div>

<!-- End Mobile Menu -->
  
  
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">
  <a href="../index.html" class="version">v2.8.0+cu128</a>
</div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../intro.html">
    Intro
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../compilers_index.html">
    Compilers
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../domains.html">
    Domains
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../distributed.html">
    Distributed
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../deep-dive.html">
    Deep Dive
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../extension.html">
    Extension
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../ecosystem.html">
    Ecosystem
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../recipes_index.html">
    Recipes
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">
<div class="search-container-wrapper">
  <div id="sphinx-search" class="search-container">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </div>

  <div id="google-search" class="search-container" style="display:none;">
    <div class="gcse-search-wrapper">
      <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
      <div class="gcse-search"></div>
    </div>
  </div>

  <div class="search-toggle-container" data-bs-title="Google Search Off" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <div class="search-toggle-inner">
      <label class="switch">
        <input type="checkbox" id="search-toggle">
        <span class="slider round"></span>
      </label>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
  // Define the search callback
  const myWebSearchStartingCallback = (gname, query) => {
    if (typeof dataLayer !== 'undefined' && query) {
      window.dataLayer = window.dataLayer || [];
      dataLayer.push({
        'event': 'google_search',
        'search_term': query,
        'event_category': 'Search',
        'event_label': 'Google Search'
      });
    }
    return '';
  };

  // Set up the GCSE search callbacks
  window.__gcse || (window.__gcse = {});
  window.__gcse.searchCallbacks = {
    web: { starting: myWebSearchStartingCallback }
  };

  if (window.location.pathname.includes('/search.html')) {
    document.body.classList.add('search-page');
  }

  // Function to reinitialize Google CSE
  function reinitializeGoogleSearch() {
    if (window.__gcse && window.__gcse.initializationCallback) {
      window.__gcse.initializationCallback();
    }
  }

  // Function to handle search toggle
  function handleSearchToggle(toggle, sphinxSearch, googleSearch) {
    if (!toggle || !sphinxSearch || !googleSearch) return;

    // Check if the URL contains /stable/ or /tutorials/
    const currentUrl = window.location.href;
    // TODO: We've had reports that the google programmable search is returning stale documentation,
    //       Simple reproduction is to turn google search on and search for multinomial which will
    //       result in returning 1.8.1 documentation.
    //       We should turn this back on when we resolve that bug.
    const shouldDefaultToGoogle = false;
    const savedPreference = localStorage.getItem('searchPreference');

    // Set initial state
    if (savedPreference === 'google' || (savedPreference === null && shouldDefaultToGoogle)) {
      toggle.checked = true;
      sphinxSearch.style.display = 'none';
      googleSearch.style.display = 'block';
      if (savedPreference === null) {
        localStorage.setItem('searchPreference', 'google');
      }
      reinitializeGoogleSearch();
    } else {
      toggle.checked = false;
      sphinxSearch.style.display = 'block';
      googleSearch.style.display = 'none';
    }

    // Update tooltip
    updateTooltip(toggle.checked);

    // Skip if already initialized
    if (toggle.hasAttribute('data-initialized')) return;
    toggle.setAttribute('data-initialized', 'true');

    toggle.addEventListener('change', function() {
      if (this.checked) {
        sphinxSearch.style.display = 'none';
        googleSearch.style.display = 'block';
        localStorage.setItem('searchPreference', 'google');
        reinitializeGoogleSearch();
        trackSearchEngineSwitch('Google');
      } else {
        sphinxSearch.style.display = 'block';
        googleSearch.style.display = 'none';
        localStorage.setItem('searchPreference', 'sphinx');
        trackSearchEngineSwitch('Sphinx');
      }

      updateTooltip(this.checked);
      updateMobileSearch();
    });
  }

  // Update tooltip based on toggle state
  function updateTooltip(isChecked) {
    const tooltipElement = document.querySelector('.search-toggle-container');
    if (!tooltipElement) return;

    tooltipElement.setAttribute('data-bs-title', isChecked ? 'Google Search On' : 'Google Search Off');

    if (bootstrap && bootstrap.Tooltip) {
      const tooltipInstance = bootstrap.Tooltip.getInstance(tooltipElement);
      if (tooltipInstance) tooltipInstance.dispose();
      new bootstrap.Tooltip(tooltipElement);
    }
  }

  // Track search engine switch
  function trackSearchEngineSwitch(engine) {
    if (typeof dataLayer !== 'undefined') {
      window.dataLayer = window.dataLayer || [];
      dataLayer.push({
        'event': 'search_engine_switch',
        'event_category': 'Search',
        'event_label': engine
      });
    }
  }

  // Function to update mobile search based on current toggle state
  function updateMobileSearch() {
    const toggle = document.getElementById('search-toggle');
    if (!toggle) return;

    const mobileSearchContainer = document.querySelector('.sidebar-header-items__end .navbar-item .search-container-wrapper');
    if (!mobileSearchContainer) return;

    const mobileSphinxSearch = mobileSearchContainer.querySelector('#sphinx-search');
    const mobileGoogleSearch = mobileSearchContainer.querySelector('#google-search');

    if (mobileSphinxSearch && mobileGoogleSearch) {
      mobileSphinxSearch.style.display = toggle.checked ? 'none' : 'block';
      mobileGoogleSearch.style.display = toggle.checked ? 'block' : 'none';

      if (toggle.checked) {
        reinitializeGoogleSearch();
      }
    }
  }

  // Initialize desktop search toggle
  const toggle = document.getElementById('search-toggle');
  const sphinxSearch = document.getElementById('sphinx-search');
  const googleSearch = document.getElementById('google-search');
  handleSearchToggle(toggle, sphinxSearch, googleSearch);

  // Set placeholder text for Google search input
  const observer = new MutationObserver(function() {
    document.querySelectorAll('.gsc-input input').forEach(input => {
      if (input && !input.hasAttribute('data-placeholder-set')) {
        input.setAttribute('placeholder', 'Search the docs ...');
        input.setAttribute('data-placeholder-set', 'true');
      }
    });
  });

  observer.observe(document.body, { childList: true, subtree: true });

  // Fix for scroll jump issue - improved approach
  function setupSearchInputHandlers(input) {
    if (input.hasAttribute('data-scroll-fixed')) return;
    input.setAttribute('data-scroll-fixed', 'true');

    let lastScrollPosition = 0;
    let isTyping = false;
    let scrollTimeout;

    // Save position before typing starts
    input.addEventListener('keydown', () => {
      lastScrollPosition = window.scrollY;
      isTyping = true;

      // Reset typing state after a short delay
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        isTyping = false;
      }, 100);
    });

    // Only maintain scroll position during typing
    function maintainScroll() {
      if (document.activeElement === input && isTyping) {
        window.scrollTo(0, lastScrollPosition);
        requestAnimationFrame(maintainScroll);
      }
    }

    input.addEventListener('focus', () => {
      // Just store initial position but don't force it
      lastScrollPosition = window.scrollY;
    });

    input.addEventListener('input', () => {
      isTyping = true;
      window.scrollTo(0, lastScrollPosition);

      // Reset typing state after a short delay
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        isTyping = false;
      }, 100);

      requestAnimationFrame(maintainScroll);
    });
  }

  // Apply to all search inputs and observe for new ones
  function applyToSearchInputs() {
    document.querySelectorAll('.search-container input, .gsc-input input').forEach(setupSearchInputHandlers);
  }

  applyToSearchInputs();

  const searchObserver = new MutationObserver(applyToSearchInputs);
  searchObserver.observe(document.body, { childList: true, subtree: true });

  // Watch for mobile menu creation
  const mobileMenuObserver = new MutationObserver(function(mutations) {
    for (const mutation of mutations) {
      if (!mutation.addedNodes.length) continue;

      // Style mobile search inputs
      document.querySelectorAll('.sidebar-header-items__end .navbar-item .search-container-wrapper .gsc-input input').forEach(input => {
        if (input) {
          input.setAttribute('placeholder', 'Search the docs ...');
          input.style.paddingLeft = '36px';
        }
      });

      // Check for mobile search container
      const mobileSearchContainer = document.querySelector('.sidebar-header-items__end .navbar-item .search-container-wrapper');
      if (!mobileSearchContainer) continue;

      const mobileToggle = mobileSearchContainer.querySelector('#search-toggle');
      if (mobileToggle && toggle) {
        // Sync mobile toggle with desktop toggle
        mobileToggle.checked = toggle.checked;
        updateMobileSearch();

        // Add event listener to mobile toggle if not already added
        if (!mobileToggle.hasAttribute('data-initialized')) {
          mobileToggle.setAttribute('data-initialized', 'true');
          mobileToggle.addEventListener('change', function() {
            // Sync desktop toggle with mobile toggle
            toggle.checked = this.checked;
            // Trigger change event on desktop toggle to update both
            toggle.dispatchEvent(new Event('change'));
          });
        }
      }
    }
  });

  mobileMenuObserver.observe(document.body, { childList: true, subtree: true });

  // Ensure Google CSE is properly loaded
  if (window.__gcse) {
    window.__gcse.callback = function() {
      // This will run after Google CSE is fully loaded
      if (toggle && toggle.checked) {
        reinitializeGoogleSearch();
      }
    };
  } else {
    window.__gcse = {
      callback: function() {
        if (toggle && toggle.checked) {
          reinitializeGoogleSearch();
        }
      }
    };
  }
});
</script>
</div>
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/PyTorchKorea/tutorials-kr" title="한국어 튜토리얼 GitHub 저장소" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">한국어 튜토리얼 GitHub 저장소</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://discuss.pytorch.kr/" title="파이토치 한국어 커뮤니티" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">파이토치 한국어 커뮤니티</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../intro.html">
    Intro
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../compilers_index.html">
    Compilers
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../domains.html">
    Domains
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../distributed.html">
    Distributed
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../deep-dive.html">
    Deep Dive
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../extension.html">
    Extension
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../ecosystem.html">
    Ecosystem
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../recipes_index.html">
    Recipes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="search-container-wrapper">
  <div id="sphinx-search" class="search-container">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </div>

  <div id="google-search" class="search-container" style="display:none;">
    <div class="gcse-search-wrapper">
      <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
      <div class="gcse-search"></div>
    </div>
  </div>

  <div class="search-toggle-container" data-bs-title="Google Search Off" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <div class="search-toggle-inner">
      <label class="switch">
        <input type="checkbox" id="search-toggle">
        <span class="slider round"></span>
      </label>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
  // Define the search callback
  const myWebSearchStartingCallback = (gname, query) => {
    if (typeof dataLayer !== 'undefined' && query) {
      window.dataLayer = window.dataLayer || [];
      dataLayer.push({
        'event': 'google_search',
        'search_term': query,
        'event_category': 'Search',
        'event_label': 'Google Search'
      });
    }
    return '';
  };

  // Set up the GCSE search callbacks
  window.__gcse || (window.__gcse = {});
  window.__gcse.searchCallbacks = {
    web: { starting: myWebSearchStartingCallback }
  };

  if (window.location.pathname.includes('/search.html')) {
    document.body.classList.add('search-page');
  }

  // Function to reinitialize Google CSE
  function reinitializeGoogleSearch() {
    if (window.__gcse && window.__gcse.initializationCallback) {
      window.__gcse.initializationCallback();
    }
  }

  // Function to handle search toggle
  function handleSearchToggle(toggle, sphinxSearch, googleSearch) {
    if (!toggle || !sphinxSearch || !googleSearch) return;

    // Check if the URL contains /stable/ or /tutorials/
    const currentUrl = window.location.href;
    // TODO: We've had reports that the google programmable search is returning stale documentation,
    //       Simple reproduction is to turn google search on and search for multinomial which will
    //       result in returning 1.8.1 documentation.
    //       We should turn this back on when we resolve that bug.
    const shouldDefaultToGoogle = false;
    const savedPreference = localStorage.getItem('searchPreference');

    // Set initial state
    if (savedPreference === 'google' || (savedPreference === null && shouldDefaultToGoogle)) {
      toggle.checked = true;
      sphinxSearch.style.display = 'none';
      googleSearch.style.display = 'block';
      if (savedPreference === null) {
        localStorage.setItem('searchPreference', 'google');
      }
      reinitializeGoogleSearch();
    } else {
      toggle.checked = false;
      sphinxSearch.style.display = 'block';
      googleSearch.style.display = 'none';
    }

    // Update tooltip
    updateTooltip(toggle.checked);

    // Skip if already initialized
    if (toggle.hasAttribute('data-initialized')) return;
    toggle.setAttribute('data-initialized', 'true');

    toggle.addEventListener('change', function() {
      if (this.checked) {
        sphinxSearch.style.display = 'none';
        googleSearch.style.display = 'block';
        localStorage.setItem('searchPreference', 'google');
        reinitializeGoogleSearch();
        trackSearchEngineSwitch('Google');
      } else {
        sphinxSearch.style.display = 'block';
        googleSearch.style.display = 'none';
        localStorage.setItem('searchPreference', 'sphinx');
        trackSearchEngineSwitch('Sphinx');
      }

      updateTooltip(this.checked);
      updateMobileSearch();
    });
  }

  // Update tooltip based on toggle state
  function updateTooltip(isChecked) {
    const tooltipElement = document.querySelector('.search-toggle-container');
    if (!tooltipElement) return;

    tooltipElement.setAttribute('data-bs-title', isChecked ? 'Google Search On' : 'Google Search Off');

    if (bootstrap && bootstrap.Tooltip) {
      const tooltipInstance = bootstrap.Tooltip.getInstance(tooltipElement);
      if (tooltipInstance) tooltipInstance.dispose();
      new bootstrap.Tooltip(tooltipElement);
    }
  }

  // Track search engine switch
  function trackSearchEngineSwitch(engine) {
    if (typeof dataLayer !== 'undefined') {
      window.dataLayer = window.dataLayer || [];
      dataLayer.push({
        'event': 'search_engine_switch',
        'event_category': 'Search',
        'event_label': engine
      });
    }
  }

  // Function to update mobile search based on current toggle state
  function updateMobileSearch() {
    const toggle = document.getElementById('search-toggle');
    if (!toggle) return;

    const mobileSearchContainer = document.querySelector('.sidebar-header-items__end .navbar-item .search-container-wrapper');
    if (!mobileSearchContainer) return;

    const mobileSphinxSearch = mobileSearchContainer.querySelector('#sphinx-search');
    const mobileGoogleSearch = mobileSearchContainer.querySelector('#google-search');

    if (mobileSphinxSearch && mobileGoogleSearch) {
      mobileSphinxSearch.style.display = toggle.checked ? 'none' : 'block';
      mobileGoogleSearch.style.display = toggle.checked ? 'block' : 'none';

      if (toggle.checked) {
        reinitializeGoogleSearch();
      }
    }
  }

  // Initialize desktop search toggle
  const toggle = document.getElementById('search-toggle');
  const sphinxSearch = document.getElementById('sphinx-search');
  const googleSearch = document.getElementById('google-search');
  handleSearchToggle(toggle, sphinxSearch, googleSearch);

  // Set placeholder text for Google search input
  const observer = new MutationObserver(function() {
    document.querySelectorAll('.gsc-input input').forEach(input => {
      if (input && !input.hasAttribute('data-placeholder-set')) {
        input.setAttribute('placeholder', 'Search the docs ...');
        input.setAttribute('data-placeholder-set', 'true');
      }
    });
  });

  observer.observe(document.body, { childList: true, subtree: true });

  // Fix for scroll jump issue - improved approach
  function setupSearchInputHandlers(input) {
    if (input.hasAttribute('data-scroll-fixed')) return;
    input.setAttribute('data-scroll-fixed', 'true');

    let lastScrollPosition = 0;
    let isTyping = false;
    let scrollTimeout;

    // Save position before typing starts
    input.addEventListener('keydown', () => {
      lastScrollPosition = window.scrollY;
      isTyping = true;

      // Reset typing state after a short delay
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        isTyping = false;
      }, 100);
    });

    // Only maintain scroll position during typing
    function maintainScroll() {
      if (document.activeElement === input && isTyping) {
        window.scrollTo(0, lastScrollPosition);
        requestAnimationFrame(maintainScroll);
      }
    }

    input.addEventListener('focus', () => {
      // Just store initial position but don't force it
      lastScrollPosition = window.scrollY;
    });

    input.addEventListener('input', () => {
      isTyping = true;
      window.scrollTo(0, lastScrollPosition);

      // Reset typing state after a short delay
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        isTyping = false;
      }, 100);

      requestAnimationFrame(maintainScroll);
    });
  }

  // Apply to all search inputs and observe for new ones
  function applyToSearchInputs() {
    document.querySelectorAll('.search-container input, .gsc-input input').forEach(setupSearchInputHandlers);
  }

  applyToSearchInputs();

  const searchObserver = new MutationObserver(applyToSearchInputs);
  searchObserver.observe(document.body, { childList: true, subtree: true });

  // Watch for mobile menu creation
  const mobileMenuObserver = new MutationObserver(function(mutations) {
    for (const mutation of mutations) {
      if (!mutation.addedNodes.length) continue;

      // Style mobile search inputs
      document.querySelectorAll('.sidebar-header-items__end .navbar-item .search-container-wrapper .gsc-input input').forEach(input => {
        if (input) {
          input.setAttribute('placeholder', 'Search the docs ...');
          input.style.paddingLeft = '36px';
        }
      });

      // Check for mobile search container
      const mobileSearchContainer = document.querySelector('.sidebar-header-items__end .navbar-item .search-container-wrapper');
      if (!mobileSearchContainer) continue;

      const mobileToggle = mobileSearchContainer.querySelector('#search-toggle');
      if (mobileToggle && toggle) {
        // Sync mobile toggle with desktop toggle
        mobileToggle.checked = toggle.checked;
        updateMobileSearch();

        // Add event listener to mobile toggle if not already added
        if (!mobileToggle.hasAttribute('data-initialized')) {
          mobileToggle.setAttribute('data-initialized', 'true');
          mobileToggle.addEventListener('change', function() {
            // Sync desktop toggle with mobile toggle
            toggle.checked = this.checked;
            // Trigger change event on desktop toggle to update both
            toggle.dispatchEvent(new Event('change'));
          });
        }
      }
    }
  });

  mobileMenuObserver.observe(document.body, { childList: true, subtree: true });

  // Ensure Google CSE is properly loaded
  if (window.__gcse) {
    window.__gcse.callback = function() {
      // This will run after Google CSE is fully loaded
      if (toggle && toggle.checked) {
        reinitializeGoogleSearch();
      }
    };
  } else {
    window.__gcse = {
      callback: function() {
        if (toggle && toggle.checked) {
          reinitializeGoogleSearch();
        }
      }
    };
  }
});
</script>
</div>
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/PyTorchKorea/tutorials-kr" title="한국어 튜토리얼 GitHub 저장소" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">한국어 튜토리얼 GitHub 저장소</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://discuss.pytorch.kr/" title="파이토치 한국어 커뮤니티" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">파이토치 한국어 커뮤니티</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Pytorch와...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">
<div class="rating">
    Rate this Page
    <div class="stars">
        
        <span class="star" data-behavior="tutorial-rating" data-count="1" data-value="1">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="2" data-value="2">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="3" data-value="3">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="4" data-value="4">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="5" data-value="5">★</span>
        
    </div>
</div>
</div>
      
    </div>
  
</div>
</div>
              
              
  
<div id="searchbox"></div>
  <article class="bd-article" id="pytorch-article">
    <!-- Hidden breadcrumb schema for SEO only -->
    <div style="display:none;" itemscope itemtype="https://schema.org/BreadcrumbList">
      
      <div itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <meta itemprop="name" content="Pytorch와 TIAToolbox를 사용한 전체 슬라이드 이미지(Whole Slide Image) 분류">
        <meta itemprop="position" content="1">
      </div>
    </div>

    
    <script>
      if ((window.location.href.indexOf("/unstable/") != -1) && (window.location.href.indexOf("/unstable/unstable_index") < 1)) {
        var div = '<div class="prototype-banner"><i class="fa fa-flask" aria-hidden="true"></i> <strong>Unstable feature:</strong> Not typically available in binary distributions like PyPI. Early stage for feedback and testing.</div>'
        document.addEventListener('DOMContentLoaded', function () {
          document.getElementById("pytorch-article").insertAdjacentHTML('afterBegin', div);
        });
      }
    </script>
    
    
    <div class="pytorch-call-to-action-links">
      <div id="tutorial-type">intermediate/tiatoolbox_tutorial</div>
      <a id="colab-link" data-behavior="call-to-action-event" data-response="Run in Google Colab" target="_blank">
        <div id="google-colab-link">
          <img class="call-to-action-img" src="../_static/img/pytorch-colab.svg" />
          <div class="call-to-action-desktop-view">Run in Google Colab</div>
          <div class="call-to-action-mobile-view">Colab</div>
        </div>
      </a>
      <a id="notebook-link" data-behavior="call-to-action-event" data-response="Download Notebook">
        <div id="download-notebook-link">
          <img class="call-to-action-notebook-img" src="../_static/img/pytorch-download.svg" />
          <div class="call-to-action-desktop-view">Download Notebook</div>
          <div class="call-to-action-mobile-view">Notebook</div>
        </div>
      </a>
      <a id="github-link" data-behavior="call-to-action-event" data-response="View on Github" target="_blank">
        <div id="github-view-link">
          <img class="call-to-action-img" src="../_static/img/pytorch-github.svg" />
          <div class="call-to-action-desktop-view">View on GitHub</div>
          <div class="call-to-action-mobile-view">GitHub</div>
        </div>
      </a>
    </div>
    

    
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="pytorch-tiatoolbox-whole-slide-image">
<h1>Pytorch와 TIAToolbox를 사용한 전체 슬라이드 이미지(Whole Slide Image) 분류<a class="headerlink" href="#pytorch-tiatoolbox-whole-slide-image" title="Link to this heading">#</a></h1>
<p><strong>번역</strong>: <a class="reference external" href="https://github.com/jkworldchampion">박주환</a></p>
<div class="admonition tip">
<p class="admonition-title">팁</p>
<p>이 튜토리얼을 최대한 활용하려면, 이 <a class="reference external" href="https://colab.research.google.com/github/pytorch/tutorials/blob/main/_static/tiatoolbox_tutorial.ipynb">Colab 버전</a> 을
사용하는 것을 권장합니다. 이를 통해 아래의 자료를 실험해 볼 수 있습니다.</p>
</div>
<section id="id2">
<h2>개요<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>본 튜토리얼에서는 TIAToolbox를 사용한 PyTorch 모델을 통해
전체 슬라이드 이미지들(Whole Slide Images, WSIs)을 분류하는
방법을 알아보겠습니다. WSI란 수술이나 생검을 통해 채취된 인간
조직 샘플의 이미지이며, 이러한 이미지는 전문 스캐너를 이용해
스캔 됩니다. 이 데이터는 병리학자와 전산 병리학자들이
종양 성장에 대한 이해를 높이고 환자 치료를 개선하기 위해
<a class="reference external" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7522141/">암과 같은 질병을 미시적 수준에서 연구</a>
하는데 사용됩니다.</p>
<p>WSIs를 처리하는 것이 어려운 이유는 엄청난 크기 때문입니다. 예컨대,
일반적인 슬라이드 이미지가 <a class="reference external" href="https://doi.org/10.1117%2F12.912388">100,000x100,000
픽셀</a> 정도의 크기를 가지며,
각 픽셀은 슬라이드 상에서 약 0.25x0.25 마이크로미터에 해당합니다.
이 때문에 이미지를 로드하고 처리하는 데 어려움을 야기하며, 한 연구에서
수백 개나 수천 개의 WSIs가 포함되는 경우는 말할 것도 없습니다
더 큰 연구가 더 나은 결과를 제공합니다!</p>
<p>전통적인 이미지 처리 파이프라인은 WSIs 처리에
적합하지 않으므로 더 나은 도구가 필요합니다.
이때, <a class="reference external" href="https://github.com/TissueImageAnalytics/tiatoolbox">TIAToolbox</a> 가
도움이 될 수 있는데, 이는 조직 슬라이드(tissue slides)를 빠르고
효율적으로 처리할 수 있는 유용한 도구들을 제공합니다.
일반적으로 WSIs는 시각화에 최적화된
다양한 배율에서 동일한 이미지의 여러 복사본이 피라미드 구조로 저장됩니다.
피라미드의 레벨 0(또는 가장 아래 단계)에는 가장 높은
배율 또는 줌 수준의 이미지를 포함하며,
피라미드의 상위 단계로 갈수록 기본 이미지의 저 해상도 사본이 있습니다.
하단에 피라미드의 구조가 그려져 있습니다.</p>
<p><img alt="WSI pyramid stack" src="../_images/read_bounds_tissue.webp" /> <em>WSI 피라미드 stack
(</em><a class="reference external" href="https://tia-toolbox.readthedocs.io/en/latest/_autosummary/tiatoolbox.wsicore.wsireader.WSIReader.html#">source</a><em>)</em></p>
<p>TIAToolbox를 사용하면 <a class="reference external" href="https://doi.org/10.1016/j.media.2022.102685">조직
분류</a> 와 같은 일반적인
후속 분석 작업을 자동화할 수 있습니다. 본 튜토리얼에서는 다음을 수행하는
방법을 보여줍니다: 1. TIAToolbox를 사용하여 WSI(Whole Slide Image)를
이미지를 로드하는 방법 2. 서로 다른 Pytorch 모델을 사용하여 슬라이드를
패치 레벨(patch-level)에서 분류하는 방법. 본 튜토리얼에서는 TorchVision의
<code class="docutils literal notranslate"><span class="pre">ResNet18</span></code> 모델과 커스텀(custom) <a class="reference external" href="https://github.com/jopo666/HistoEncoder">HistoEncoder</a>
모델을 사용하는 예제를 제공합니다.</p>
<p>시작해보자!</p>
</section>
<section id="id3">
<h2>환경설정<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>본 튜토리얼에서 제공하는 예제를 실행하려면, 다음과 같은 패키지(packages)가
필요합니다.</p>
<ol class="arabic simple">
<li><p>OpenJpeg</p></li>
<li><p>OpenSlide</p></li>
<li><p>Pixman</p></li>
<li><p>TIAToolbox</p></li>
<li><p>HistoEncoder (for a custom model example)</p></li>
</ol>
<p>이 패키지들을 설치하기 위해 터미널(terminal)에 아래의
명령어를 실행해주세요:</p>
<ul class="simple">
<li><p><cite>apt-get -y -qq install libopenjp2-7-dev libopenjp2-tools openslide-tools libpixman-1-dev</cite></p></li>
<li><p><cite>pip install -q ‘tiatoolbox&lt;1.5’ histoencoder &amp;&amp; echo “Installation is done.”</cite></p></li>
</ul>
<p>또한, MacOS에서는 <code class="docutils literal notranslate"><span class="pre">apt-get</span></code> 대신에 <code class="docutils literal notranslate"><span class="pre">brew</span> <span class="pre">install</span> <span class="pre">openjpeg</span> <span class="pre">openslide</span></code>
명령어를 실행하여 필수 패키지들을 설치할 수 있습니다.
설치에 대한 추가 정보는 <a class="reference external" href="https://tia-toolbox.readthedocs.io/en/latest/installation.html">여기</a>
를 참조하세요.</p>
<section id="id4">
<h3>관련 라이브러리 불러오기<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Jupyter 노트북을 실행하는 데 필요한 모듈 불러오기.&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="c1"># 로깅(logging) 설정하기</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">hasHandlers</span><span class="p">():</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;.*The &#39;nopython&#39; keyword.*&quot;</span><span class="p">)</span>

<span class="c1"># 데이터와 파일 다운로드하기</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">zipfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZipFile</span>

<span class="c1"># 데이터 처리 및 시각화</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">cm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">PIL</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>

<span class="c1"># WSI 로딩 및 처리를 위한 TIAToolbox</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tiatoolbox</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tiatoolbox.models.architecture</span><span class="w"> </span><span class="kn">import</span> <span class="n">vanilla</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tiatoolbox.models.engine.patch_predictor</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">IOPatchPredictorConfig</span><span class="p">,</span>
    <span class="n">PatchPredictor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tiatoolbox.utils.misc</span><span class="w"> </span><span class="kn">import</span> <span class="n">download_data</span><span class="p">,</span> <span class="n">grab_files_from_dir</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tiatoolbox.utils.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">overlay_prediction_mask</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tiatoolbox.wsicore.wsireader</span><span class="w"> </span><span class="kn">import</span> <span class="n">WSIReader</span>

<span class="c1"># Torch-관련</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">transforms</span>

<span class="c1"># 그래프 설정</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.dpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">160</span>  <span class="c1"># for high resolution figure in notebook</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.facecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>  <span class="c1"># To make sure text is visible in dark mode</span>

<span class="c1"># 만약 GPU를 사용하지 않는다면, ON_GPU를 False로 변경하세요.</span>
<span class="n">ON_GPU</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># 장황한 코드 블록의 콘솔 출력을 억제하는 함수</span>
<span class="k">def</span><span class="w"> </span><span class="nf">suppress_console_output</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stderr</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="clean-up">
<h3>실행 전 정리(clean-up)<a class="headerlink" href="#clean-up" title="Link to this heading">#</a></h3>
<p>적절한 정리를 보장하기 위해(예컨대, 비정상 종료), 이번 실행에서
다운로드되거나 생성된 모든 파일은 <code class="docutils literal notranslate"><span class="pre">global_save_dir</span></code> 이라는
하나의 디렉토리에 저장되며, 이 디렉토리는 “./tmp/”로 설정됩니다.
유지보수를 쉽게 하기 위해 디렉토리 이름은 이 한 곳에서만 설정되므로,
필요하면 간편하게 변경할 수 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">global_save_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./tmp/&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rmdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;디렉토리를 지우기 위한 도우미 함수&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing directory </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>


<span class="n">rmdir</span><span class="p">(</span><span class="n">global_save_dir</span><span class="p">)</span>  <span class="c1"># 이전 실행에서 디렉토리가 있는 경우 삭제</span>
<span class="n">global_save_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating new directory </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">global_save_dir</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>데이터 다운로드<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<p>샘플 데이터로는 전체 슬라이드 이미지(whole-slide image)를 사용하고
<a class="reference external" href="https://zenodo.org/record/1214456#.YJ-tn3mSkuU">Kather 100k</a> 데이터셋의
검증(validation) 하위 집단(subset)에서 추출한 패치들을 사용할 것입니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wsi_path</span> <span class="o">=</span> <span class="n">global_save_dir</span> <span class="o">/</span> <span class="s2">&quot;sample_wsi.svs&quot;</span>
<span class="n">patches_path</span> <span class="o">=</span> <span class="n">global_save_dir</span> <span class="o">/</span> <span class="s2">&quot;kather100k-validation-sample.zip&quot;</span>
<span class="n">weights_path</span> <span class="o">=</span> <span class="n">global_save_dir</span> <span class="o">/</span> <span class="s2">&quot;resnet18-kather100k.pth&quot;</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Download has started. Please wait...&quot;</span><span class="p">)</span>

<span class="c1"># 전체 슬라이드 이미지(whole-slide image) 샘플을 다운로드 하고 압축을 해제하기</span>
<span class="n">download_data</span><span class="p">(</span>
    <span class="s2">&quot;https://tiatoolbox.dcs.warwick.ac.uk/sample_wsis/TCGA-3L-AA1B-01Z-00-DX1.8923A151-A690-40B7-9E5A-FCBEDFC2394F.svs&quot;</span><span class="p">,</span>
    <span class="n">wsi_path</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Kather 100K 데이터셋을 훈련하기 위해 사용된 검증 세트(validation set) 샘플을 다운로드하고 압축을 해제하기</span>
<span class="n">download_data</span><span class="p">(</span>
    <span class="s2">&quot;https://tiatoolbox.dcs.warwick.ac.uk/datasets/kather100k-validation-sample.zip&quot;</span><span class="p">,</span>
    <span class="n">patches_path</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">patches_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipfile</span><span class="p">:</span>
    <span class="n">zipfile</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">global_save_dir</span><span class="p">)</span>

<span class="c1"># ResNet18 아키텍처로 WSI(전체 슬라이드 이미지) 분류를 위해 사전 학습된 모델 가중치를 다운로드하기</span>
<span class="n">download_data</span><span class="p">(</span>
    <span class="s2">&quot;https://tiatoolbox.dcs.warwick.ac.uk/models/pc/resnet18-kather100k.pth&quot;</span><span class="p">,</span>
    <span class="n">weights_path</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Download is complete.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="id6">
<h2>데이터 읽기<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>패치 목록과 해당되는 라벨 목록을 생성합니다.
예를 들어, <code class="docutils literal notranslate"><span class="pre">label_list</span></code> 의 첫 번째 라벨은
<code class="docutils literal notranslate"><span class="pre">patch_list</span></code> 의 첫 번째 이미지 패치의 클래스를 나타냅니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 패치 데이터를 읽고 패치 목록과 해당 라벨 목록을 생성</span>
<span class="n">dataset_path</span> <span class="o">=</span> <span class="n">global_save_dir</span> <span class="o">/</span> <span class="s2">&quot;kather100k-validation-sample&quot;</span>

<span class="c1"># 데이터셋 경로 설정</span>
<span class="n">image_ext</span> <span class="o">=</span> <span class="s2">&quot;.tif&quot;</span>  <span class="c1"># 각 이미지의 파일 확장자</span>

<span class="c1"># 라벨 ID와 클래스 이름 간의 매핑</span>
<span class="n">label_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;BACK&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># Background (empty glass region)  # 이 부분은 밑에서 자세히 설명</span>
    <span class="s2">&quot;NORM&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># Normal colon mucosa</span>
    <span class="s2">&quot;DEB&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># Debris</span>
    <span class="s2">&quot;TUM&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Colorectal adenocarcinoma epithelium</span>
    <span class="s2">&quot;ADI&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>  <span class="c1"># Adipose</span>
    <span class="s2">&quot;MUC&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># Mucus</span>
    <span class="s2">&quot;MUS&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>  <span class="c1"># Smooth muscle</span>
    <span class="s2">&quot;STR&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>  <span class="c1"># Cancer-associated stroma</span>
    <span class="s2">&quot;LYM&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>  <span class="c1"># Lymphocytes</span>
<span class="p">}</span>

<span class="n">class_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">label_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">class_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">label_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="c1"># 패치 목록 생성 및 파일 이름에서 라벨 추출하기</span>
<span class="n">patch_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">dataset_class_path</span> <span class="o">=</span> <span class="n">dataset_path</span> <span class="o">/</span> <span class="n">class_name</span>
    <span class="n">patch_list_single_class</span> <span class="o">=</span> <span class="n">grab_files_from_dir</span><span class="p">(</span>
        <span class="n">dataset_class_path</span><span class="p">,</span>
        <span class="n">file_types</span><span class="o">=</span><span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="n">image_ext</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">patch_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">patch_list_single_class</span><span class="p">)</span>
    <span class="n">label_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">label</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">patch_list_single_class</span><span class="p">))</span>

<span class="c1"># 데이터셋 통계 표기</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">class_names</span><span class="p">,</span> <span class="p">[</span><span class="n">label_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">class_labels</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Patch types&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Number of patches&quot;</span><span class="p">)</span>

<span class="c1"># 클래스별 예시 개수 집계</span>
<span class="k">for</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Class ID: </span><span class="si">%d</span><span class="s2"> -- Class Name: </span><span class="si">%s</span><span class="s2"> -- Number of images: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="p">,</span>
        <span class="n">class_name</span><span class="p">,</span>
        <span class="n">label_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">label</span><span class="p">),</span>
    <span class="p">)</span>

<span class="c1"># 전체 데이터셋 통계</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total number of patches: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">patch_list</span><span class="p">)))</span>
</pre></div>
</div>
<img src="../_images/tiatoolbox_tutorial_001.png" srcset="../_images/tiatoolbox_tutorial_001.png" alt="tiatoolbox tutorial" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>|2023-11-14|13:15:59.299| [INFO] Class ID: 0 -- Class Name: BACK -- Number of images: 211
|2023-11-14|13:15:59.299| [INFO] Class ID: 1 -- Class Name: NORM -- Number of images: 176
|2023-11-14|13:15:59.299| [INFO] Class ID: 2 -- Class Name: DEB -- Number of images: 230
|2023-11-14|13:15:59.299| [INFO] Class ID: 3 -- Class Name: TUM -- Number of images: 286
|2023-11-14|13:15:59.299| [INFO] Class ID: 4 -- Class Name: ADI -- Number of images: 208
|2023-11-14|13:15:59.299| [INFO] Class ID: 5 -- Class Name: MUC -- Number of images: 178
|2023-11-14|13:15:59.299| [INFO] Class ID: 6 -- Class Name: MUS -- Number of images: 270
|2023-11-14|13:15:59.299| [INFO] Class ID: 7 -- Class Name: STR -- Number of images: 209
|2023-11-14|13:15:59.299| [INFO] Class ID: 8 -- Class Name: LYM -- Number of images: 232
|2023-11-14|13:15:59.299| [INFO] Total number of patches: 2000
</pre></div>
</div>
<p>이 패치 데이터셋에서 볼 수 있듯이,
0부터 8까지의 ID를 가진 9개의 클래스와 라벨이 있으며,
각 클래스는 해당 패치에서 주로 나타나는 조직 유형을 설명합니다:</p>
<ul class="simple">
<li><p>BACK ⟶ 배경(Background)(비어 있는 영역)</p></li>
<li><p>LYM ⟶ 림프구(Lymphocytes)</p></li>
<li><p>NORM ⟶ 정상 대장 점막(Normal colon mucosa)</p></li>
<li><p>DEB ⟶ 조직 파편(Debris)</p></li>
<li><p>MUS ⟶ 평활근(Smooth muscle)</p></li>
<li><p>STR ⟶ 암 관련 기질(Cancer-associated stroma)</p></li>
<li><p>ADI ⟶ 지방 조직(Adipose)</p></li>
<li><p>MUC ⟶ 점액(Mucus)</p></li>
<li><p>TUM ⟶ 대장선암 상(Colorectal adenocarcinoma epithelium)</p></li>
</ul>
</section>
<section id="id7">
<h2>이미지 패치 분류<a class="headerlink" href="#id7" title="Link to this heading">#</a></h2>
<p>먼저 <code class="docutils literal notranslate"><span class="pre">patch</span></code> 모드를 사용하여 디지털 슬라이드 내의
각 패치에 대한 예측을 구하는 방법을 시연한 후, <code class="docutils literal notranslate"><span class="pre">wsi</span></code> 모드를 사용하여
큰(large) 슬라이드에 대해 예측을 수행하는 방법을 보여줍니다.</p>
<section id="patchpredictor">
<h3><code class="docutils literal notranslate"><span class="pre">PatchPredictor</span></code> 모델 정의하기<a class="headerlink" href="#patchpredictor" title="Link to this heading">#</a></h3>
<p>PatchPredictor 클래스는 PyTorch로 작성된 CNN 기반 분류기를 실행합니다</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">모델</span></code> 은 <code class="docutils literal notranslate"><span class="pre">tiatoolbox.models.abc.ModelABC</span></code> <a href="#id8"><span class="problematic" id="id9">`</span></a>(문서)</dt><dd><p>&lt;<a class="reference external" href="https://tia-toolbox.readthedocs.io/en/latest/_autosummary/tiatoolbox.models.models_abc.ModelABC.html">https://tia-toolbox.readthedocs.io/en/latest/_autosummary/tiatoolbox.models.models_abc.ModelABC.html</a>&gt;`__
클래스 구조를 따르는 모든 PyTorch로 훈련된 모델을 사용할 수 있습니다.
이에 대한 자세한 내용은 <a class="reference external" href="https://github.com/TissueImageAnalytics/tiatoolbox/blob/develop/examples/07-advanced-modeling.ipynb">고급 모델 기술에 관한 예제 노트북(notebook)</a>.
을 참조하십시오. 커스텀 모델을 로드하려면,
<code class="docutils literal notranslate"><span class="pre">preproc_func(img)</span></code> 와 같은
전처리 함수를 작성해야 하며, 이 함수는 입력 tensor가
로드된 네트워크에 적합한 형식으로 되어 있는지 확인해줍니다.</p>
</dd>
</dl>
</li>
<li><p>또한, <code class="docutils literal notranslate"><span class="pre">사전</span> <span class="pre">학습된</span> <span class="pre">모델(pretrained_model)</span></code> 을 문자열 인수로
전달할 수 있습니다. 이는 예측을 수행할 CNN 모델을 지정하며, 해당 모델은
<a class="reference external" href="https://tia-toolbox.readthedocs.io/en/stable/_autosummary/tiatoolbox.models.architecture.get_pretrained_model.html#tiatoolbox.models.architecture.get_pretrained_model">여기</a>
나열된 모델 중 하나이어야 합니다.
명령어는 다음과 같습니다:
<code class="docutils literal notranslate"><span class="pre">predictor</span> <span class="pre">=</span> <span class="pre">PatchPredictor(pretrained_model='resnet18-kather100k',</span> <span class="pre">pretrained_weights=weights_path,</span> <span class="pre">batch_size=32)</span></code> .</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pretrained_weights</span></code> : <code class="docutils literal notranslate"><span class="pre">사전</span> <span class="pre">학습된</span> <span class="pre">모델(pretrained_model)</span></code> 을 사용할 때,
해당 모델의 사전 학습된 가중치도 기본적으로 다운로드 됩니다.
기본으로 제공되는 가중치를 덮어쓰고 자신만의 가중치를 사용하려면
<code class="docutils literal notranslate"><span class="pre">pretrained_weight</span></code> 인수를 통해 가중치를 지정할 수 있습니다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code> : 모델에 한 번에 입력되는 이미지의 개수를 지정합니다. 이 값이 클수록
더 많은 (GPU)메모리 용량이 필요합니다.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TIAToolbox에서 사전 학습된 PyTorch 모델 가져오기</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">PatchPredictor</span><span class="p">(</span><span class="n">pretrained_model</span><span class="o">=</span><span class="s1">&#39;resnet18-kather100k&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>

<span class="c1"># 사용자는 아래 스크립트를 통해 원하는 PyTorch 모델 아키텍처를 불러올 수 있습니다.</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">vanilla</span><span class="o">.</span><span class="n">CNNModel</span><span class="p">(</span><span class="n">backbone</span><span class="o">=</span><span class="s2">&quot;resnet18&quot;</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span> <span class="c1"># torchvision.models.resnet18에서 모델 불러오기</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">weights_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="n">weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">preproc_func</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">preproc_func</span> <span class="o">=</span> <span class="n">preproc_func</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">PatchPredictor</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id10">
<h3>패치 라벨 예측하기<a class="headerlink" href="#id10" title="Link to this heading">#</a></h3>
<p>예측기(predictor) 객체를 생성한 후 <code class="docutils literal notranslate"><span class="pre">patch</span></code> 모드를 사용하여 <code class="docutils literal notranslate"><span class="pre">predict</span></code> 메소드를 호출합니다.
그런 다음, 분류 정확도와 오차 행렬(confusion matrix)을 계산합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">suppress_console_output</span><span class="p">():</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">imgs</span><span class="o">=</span><span class="n">patch_list</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;patch&quot;</span><span class="p">,</span> <span class="n">on_gpu</span><span class="o">=</span><span class="n">ON_GPU</span><span class="p">)</span>

<span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">label_list</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;predictions&quot;</span><span class="p">])</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Classification accuracy: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">acc</span><span class="p">)</span>

<span class="c1"># 패치 분류 결과를 위한 오차 행렬(confusion_matrix) 생성 및 시각화</span>
<span class="n">conf</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">label_list</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;predictions&quot;</span><span class="p">],</span> <span class="n">normalize</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="n">df_cm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">class_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">class_names</span><span class="p">)</span>
<span class="n">df_cm</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>|2023-11-14|13:16:03.215| [INFO] Classification accuracy: 0.993000
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BACK</th>
      <th>NORM</th>
      <th>DEB</th>
      <th>TUM</th>
      <th>ADI</th>
      <th>MUC</th>
      <th>MUS</th>
      <th>STR</th>
      <th>LYM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BACK</th>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>NORM</th>
      <td>0.000000</td>
      <td>0.988636</td>
      <td>0.000000</td>
      <td>0.011364</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>DEB</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.991304</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.008696</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>TUM</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.996503</td>
      <td>0.000000</td>
      <td>0.003497</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>ADI</th>
      <td>0.004808</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.990385</td>
      <td>0.000000</td>
      <td>0.004808</td>
      <td>0.000000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>MUC</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.988764</td>
      <td>0.000000</td>
      <td>0.011236</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>MUS</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.996296</td>
      <td>0.003704</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>STR</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.004785</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.004785</td>
      <td>0.004785</td>
      <td>0.985646</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>LYM</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.004310</td>
      <td>0.99569</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br/>
<br/></section>
<section id="whole-slide">
<h3>전체 슬라이드(whole slide)에 대한 패치 라벨 예측<a class="headerlink" href="#whole-slide" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">IOPatchPredictorConfig</span></code> 클래스를 소개합니다. 이 클래스는 모델 예측 엔진을
위한 이미지 읽기 및 예측 결과 쓰기 구성 설정을 지정합니다.
이 설정은 분류기(classifier)에게 WSI 피라미드의 어느 레벨을 읽고,
데이터를 처리하며, 출력을 생성해야 하는지 알려주는 데
필수적입니다.</p>
<p><code class="docutils literal notranslate"><span class="pre">IOPatchPredictorConfig</span></code> 의 매개변수는 다음과 같이 정의됩니다.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">input_resolutions</span></code>: 입력의 해상도를 지정하는 딕셔너리 형태의 리스트로,
각 입력의 해상도를 설정합니다. 리스트의 요소는 <code class="docutils literal notranslate"><span class="pre">model.forward()</span></code> 의
순서와 같아야합니다. 만약 모델이 하나의 입력만 받는 경우,
하나의 딕셔너리로 <code class="docutils literal notranslate"><span class="pre">'units'</span></code> 와 <code class="docutils literal notranslate"><span class="pre">'resolution'</span></code>
을 지정하면 됩니다. TIAToolbox는 하나 이상의 입력을 받는 모델을
지원하므로, 여러 입력을 사용하는 경우에도 문제없이 사용할 수 있습니다.
유닛(units)과 해상도(resolution)에 대한 자세한 내용은 <a class="reference external" href="https://tia-toolbox.readthedocs.io/en/latest/_autosummary/tiatoolbox.wsicore.wsireader.WSIReader.html#tiatoolbox.wsicore.wsireader.WSIReader.read_rect">TIAToolbox
문서</a> 를 참고하십시오.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">patch_input_shape</span></code>: 가장 큰 입력의 크기를 (높이, 너비) 형식으로
지정합니다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stride_shape</span></code>: 연속된 두 패치 사이의 간격(단계) 크기를 지정하며,
패치 추출 과정에서 사용됩니다. 사용자가
<code class="docutils literal notranslate"><span class="pre">stride_shape</span></code> 를 <code class="docutils literal notranslate"><span class="pre">patch_input_shape</span></code> 와 동일하게 설정하면, 패치들이
중첩없이 추출되고, 처리됩니다.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wsi_ioconfig</span> <span class="o">=</span> <span class="n">IOPatchPredictorConfig</span><span class="p">(</span>
    <span class="n">input_resolutions</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;mpp&quot;</span><span class="p">,</span> <span class="s2">&quot;resolution&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}],</span>
    <span class="n">patch_input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">],</span>
    <span class="n">stride_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">predict</span></code> 메소드는 입력 패치에 CNN을 적용하여 결과를 얻습니다.
다음은 해당 메소드의 인수와 설명입니다:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mode</span></code>: 처리할 입력의 유형을 지정합니다. 응용 프로그램에 따라 <code class="docutils literal notranslate"><span class="pre">patch</span></code>,
<code class="docutils literal notranslate"><span class="pre">tile</span></code> 또는 <code class="docutils literal notranslate"><span class="pre">wsi</span></code> 중에서 선택합니다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">imgs</span></code>: 입력 파일들의 경로 리스트로, 입력 타일(input tiles) 또는
WSIs 경로의 목록이어야 합니다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">return_probabilities</span></code>: 입력 패치의 예측된 라벨과 함께 클래스별
확률을 얻으려면 <strong>True</strong> 로 설정합니다. <code class="docutils literal notranslate"><span class="pre">tile</span></code> 또는 <code class="docutils literal notranslate"><span class="pre">wsi</span></code> 모드에서
예측 결과를 병합하여 예측 맵을 생성하려면 <code class="docutils literal notranslate"><span class="pre">return_probabilities=True</span></code>
로 설정할 수 있습니다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ioconfig</span></code>: <code class="docutils literal notranslate"><span class="pre">IOPatchPredictorConfig</span></code> 클래스를 사용하여 IO
구성 정보를 설정합니다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resolution</span></code> 과 <code class="docutils literal notranslate"><span class="pre">unit</span></code> (아래에 표시되지 않음): 추출할 패치의 WSI 레벨
또는 마이크론당 픽셀 해상도를 지정합니다.
이는 <code class="docutils literal notranslate"><span class="pre">ioconfig</span></code> 대신 사용할 수 있습니다.
여기서 WSI 레벨은 <code class="docutils literal notranslate"><span class="pre">'baseline'</span></code> 으로 지정하며,
이는 일반적으로 레벨 0에
이 경우 이미지는 하나의 레벨만 가지고 있습니다.
더 자세한 내용은 <a class="reference external" href="https://tia-toolbox.readthedocs.io/en/stable/_autosummary/tiatoolbox.wsicore.wsireader.WSIReader.html#tiatoolbox.wsicore.wsireader.WSIReader.read_rect">문서</a> 에서
확인할 수 있습니다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">masks</span></code>: <code class="docutils literal notranslate"><span class="pre">imgs</span></code> 리스트에 있는 WSI의 마스크 경로 리스트입니다.
이 마스크는 원본 WSI에서 패치를 추출하고자 하는 영역을
지정합니다. 특정 WSI의 마스크가 <code class="docutils literal notranslate"><span class="pre">None</span></code> 으로 지정되면,
해당 WSI의 모든 패치(배경 영역 포함)에 대한 라벨이
예측됩니다. 이는 불필요한
계산을 유발할 수 있습니다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">merge_predictions</span></code>: 패치 분류 결과를 2D 맵으로
생성해야하는 경우 <code class="docutils literal notranslate"><span class="pre">True</span></code> 로 설정할 수 있습니다.
그러나 큰 WSI의 경우 많은 메모리가 필요할 수 있습니다.
대안적인 해결책으로는 <code class="docutils literal notranslate"><span class="pre">merge_predictions=False</span></code> 로(기본값) 설정하여,
추후에 <code class="docutils literal notranslate"><span class="pre">merge_predictions</span></code> 함수를 사용해 2D 예측 맵을 생성하는
방법을 사용할 수 있습니다.</p></li>
</ul>
<p>큰 WSI를 사용하고 있기 때문에 패치 추출 및 예측 과정에 시간이 다소 걸릴 수 있습니다.
(만약 Cuda가 활성화된 GPU를 사용할 수 있다면
<code class="docutils literal notranslate"><span class="pre">ON_GPU=True</span></code> 로 설정하여 PyTorch와 Cuda를 활용하는 것이 좋습니다).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">suppress_console_output</span><span class="p">():</span>
    <span class="n">wsi_output</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">imgs</span><span class="o">=</span><span class="p">[</span><span class="n">wsi_path</span><span class="p">],</span>
        <span class="n">masks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wsi&quot;</span><span class="p">,</span>
        <span class="n">merge_predictions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ioconfig</span><span class="o">=</span><span class="n">wsi_ioconfig</span><span class="p">,</span>
        <span class="n">return_probabilities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">save_dir</span><span class="o">=</span><span class="n">global_save_dir</span> <span class="o">/</span> <span class="s2">&quot;wsi_predictions&quot;</span><span class="p">,</span>
        <span class="n">on_gpu</span><span class="o">=</span><span class="n">ON_GPU</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">wsi_output</span></code> 을 시각화하여 예측 모델이 전체 슬라이드 이미지(WSI)에서
어떻게 작동하는지 확인할 수 있습니다. 먼저 패치 예측 결과를 병합한 후,
이를 원본 이미지 위에 오버레이로 시각화해야 합니다. 이전과 마찬가지로
<code class="docutils literal notranslate"><span class="pre">merge_predictions</span></code> 메소드를 사용하여 패치 예측을 병합합니다.
이때, 1.25x 만큼 확대된 예측 맵을 생성하기 위해
<code class="docutils literal notranslate"><span class="pre">resolution=1.25,</span> <span class="pre">units='power'</span></code> 로 매개변수를 설정합니다.
만약 더 높은/낮은 해상도 (더 큰/작은) 예측 맵을 원한다면,
이 매개변수를 적절히 변경해야 합니다.
예측이 병합되면 <code class="docutils literal notranslate"><span class="pre">overlay_patch_prediction</span></code> 함수를 사용하여
예측 맵을 WSI 썸네일에 오버레이합니다. 이때 사용된 해상도는
예측 병합에 사용된 해상도와
일치해야합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">overview_resolution</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">4</span>  <span class="c1"># 패치 예측을 병합하고 시각화하는 해상도 설정</span>
<span class="p">)</span>
<span class="c1"># &#39;해상도&#39; 매개변수의 단위 설정. &quot;power&quot;, &quot;level&quot;, &quot;mpp&quot;, 또는 &quot;baseline&quot; 중에서 선택 가능</span>
<span class="n">overview_unit</span> <span class="o">=</span> <span class="s2">&quot;mpp&quot;</span>
<span class="n">wsi</span> <span class="o">=</span> <span class="n">WSIReader</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">wsi_path</span><span class="p">)</span>
<span class="n">wsi_overview</span> <span class="o">=</span> <span class="n">wsi</span><span class="o">.</span><span class="n">slide_thumbnail</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">overview_resolution</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">overview_unit</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(),</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wsi_overview</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/tiatoolbox_tutorial_002.png" srcset="../_images/tiatoolbox_tutorial_002.png" alt="tiatoolbox tutorial" class = "sphx-glr-single-img"/><p>예측 맵을 이 이미지에 오버레이한 결과는 다음과 같습니다:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 전체 슬라이드 이미지(Whole slide image)의 패치 레벨 예측 시각화</span>
<span class="c1"># 먼저 라벨 색상의 매핑 설정</span>
<span class="n">label_color_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">label_color_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;empty&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;Set1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">colors</span>
<span class="k">for</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">label_color_dict</span><span class="p">[</span><span class="n">label</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="mi">255</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">label</span><span class="p">]))</span>

<span class="n">pred_map</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">merge_predictions</span><span class="p">(</span>
    <span class="n">wsi_path</span><span class="p">,</span>
    <span class="n">wsi_output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">resolution</span><span class="o">=</span><span class="n">overview_resolution</span><span class="p">,</span>
    <span class="n">units</span><span class="o">=</span><span class="n">overview_unit</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">overlay</span> <span class="o">=</span> <span class="n">overlay_prediction_mask</span><span class="p">(</span>
    <span class="n">wsi_overview</span><span class="p">,</span>
    <span class="n">pred_map</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">label_info</span><span class="o">=</span><span class="n">label_color_dict</span><span class="p">,</span>
    <span class="n">return_ax</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../_images/tiatoolbox_tutorial_003.png" srcset="../_images/tiatoolbox_tutorial_003.png" alt="tiatoolbox tutorial" class = "sphx-glr-single-img"/></section>
</section>
<section id="id11">
<h2>병리학에 특화된 모델을 사용한 특징 추출<a class="headerlink" href="#id11" title="Link to this heading">#</a></h2>
<p>이 부분에서는 TIAToolbox 외부에 존재하는 사전 학습된
PyTorch 모델에서 특징을 추출하는 방법을 TIAToolbox에서
제공하는 WSI 추론 엔진을 사용하여 보여줍니다. 이를 설명하기 위해,
HistoEncoder라는 병리학적 이미지에 특화된 모델을 사용할 것입니다.
HistoEncoder는 조직학 이미지에서 특징을 추출하도록 자가 지도 학습 방식(self-supervised)
으로 학습되었습니다. 이 모델은 다음에서 사용할 수 있습니다:</p>
<p>‘HistoEncoder: 디지털 병리학을 위한 기본 모델’
(<a class="github reference external" href="https://github.com/jopo666/HistoEncoder">jopo666/HistoEncoder</a>) 헬싱키 대학교
Pohjonen, Joona 팀.</p>
<p>특징 맵의 umap 차원 축소를 3D(RGB)로 시각화하여,
위에서 언급한 여러 조직 유형 간의 차이를 특징들이
어떻게 포착하는지 보여줄 것입니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 추가 module 가져오기</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">histoencoder.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">tiatoolbox.models.engine.semantic_segmentor</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeepFeatureExtractor</span><span class="p">,</span> <span class="n">IOSegmentorConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tiatoolbox.models.models_abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelABC</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">umap</span>
</pre></div>
</div>
<p>TIAToolbox는 PyTorch의 <a class="reference external" href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html">nn.Module</a>
을 상속하는 ModelABC 클래스를 정의하며,
이는 TIAToolbox의 추론 엔진에서 사용될 모델의
구조를 규정합니다. 하지만 histoencoder 모델은 이 구조를
따르지 않기 때문에, TIAToolbox 엔진이 기대하는 출력과
메소드를 제공하는 클래스로 HistoEncoder를 래핑(wrap)해야 합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HistoEncWrapper</span><span class="p">(</span><span class="n">ModelABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;tiatoolbox의 ModelABC 인터페이스에 맞춘 HistoEncW모델의 레퍼 생성&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">HistoEncWrapper</span><span class="p">,</span> <span class="n">encoder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feat_extract</span> <span class="o">=</span> <span class="n">encoder</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">HistoEncWrapper</span><span class="p">,</span> <span class="n">imgs</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;입력 데이터를 모델을 통해 전달</span>

<span class="sd">        Args:</span>
<span class="sd">            imgs (torch.Tensor):</span>
<span class="sd">                Model input.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_extract</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">num_blocks</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">avg_pool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">infer_batch</span><span class="p">(</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">batch_data</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">on_gpu</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;입력 배치에 대한 추론 실행</span>

<span class="sd">        순방향 연산과 입출력 집계를 위한 로직이 포함되어 있습니다.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (nn.Module):</span>
<span class="sd">                정의된 PyTorch 모델.</span>
<span class="sd">            batch_data (torch.Tensor):</span>
<span class="sd">                `torch.utils.data.DataLoader`에</span>
<span class="sd">                의해 생성된 데이터의 배치(batch).</span>
<span class="sd">            on_gpu (bool):</span>
<span class="sd">                추론 연산을 GPU에서 할 것인지.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img_patches_device</span> <span class="o">=</span> <span class="n">batch_data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">on_gpu</span> <span class="k">else</span> <span class="n">batch_data</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># 기울기를 계산하지 않음(훈련이 아님)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">img_patches_device</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]</span>
</pre></div>
</div>
<p>이제 래퍼(wrapper)를 만들었으니, 특징 추출 모델을
생성하고 <a class="reference external" href="https://tia-toolbox.readthedocs.io/en/v1.4.1/_autosummary/tiatoolbox.models.engine.semantic_segmentor.DeepFeatureExtractor.html">DeepFeatureExtractor</a>
를 인스턴스화 하여 이 모델을
WSI에 사용할 수 있게 합니다. 이전에 사용했던 동일한 WSI를 사용하지만,
이번에는 각 패치에 대한 라벨을 예측하는 대신
HistoEncoder 모델을 사용하여, WSI의 패치에서
특징을 추출할 것입니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 모델 만들기</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">create_encoder</span><span class="p">(</span><span class="s2">&quot;prostate_medium&quot;</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">HistoEncWrapper</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span>

<span class="c1"># 전처리 함수 설정</span>
<span class="n">norm</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.662</span><span class="p">,</span> <span class="mf">0.446</span><span class="p">,</span> <span class="mf">0.605</span><span class="p">],</span><span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.169</span><span class="p">,</span> <span class="mf">0.190</span><span class="p">,</span> <span class="mf">0.155</span><span class="p">])</span>
<span class="n">trans</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="n">norm</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">model</span><span class="o">.</span><span class="n">preproc_func</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>

<span class="n">wsi_ioconfig</span> <span class="o">=</span> <span class="n">IOSegmentorConfig</span><span class="p">(</span>
    <span class="n">input_resolutions</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;mpp&quot;</span><span class="p">,</span> <span class="s2">&quot;resolution&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}],</span>
    <span class="n">patch_input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">],</span>
    <span class="n">output_resolutions</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;mpp&quot;</span><span class="p">,</span> <span class="s2">&quot;resolution&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}],</span>
    <span class="n">patch_output_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">],</span>
    <span class="n">stride_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">DeepFeatureExtractor</span></code> 를 생성할 때
<code class="docutils literal notranslate"><span class="pre">auto_generate_mask=True</span></code> 인수를 전달할 것입니다. 이는 otsu 임계값
알고리즘을 사용하여 자동으로 조직 영역의 마스크를 생성하여, 추출기가
조직이 포함된 패치에만 처리하도록 합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 특징 추출기 생성 및 WSI에서 실행하기</span>
<span class="n">extractor</span> <span class="o">=</span> <span class="n">DeepFeatureExtractor</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">auto_generate_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">num_loader_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_postproc_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="k">with</span> <span class="n">suppress_console_output</span><span class="p">():</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">imgs</span><span class="o">=</span><span class="p">[</span><span class="n">wsi_path</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wsi&quot;</span><span class="p">,</span> <span class="n">ioconfig</span><span class="o">=</span><span class="n">wsi_ioconfig</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">global_save_dir</span> <span class="o">/</span> <span class="s2">&quot;wsi_features&quot;</span><span class="p">,)</span>
</pre></div>
</div>
<p>이러한 특징들은 다운스트림 모델을 훈련하는 데 사용할 수 있지만, 여기서는
특징이 무엇을 나타내는지 직관적으로 이해하기 위해 UMAP 차원 축소를 사용하여
특징을 RGB 공간에서 시각화할 것입니다. 유사한 색상으로 라벨링된 포인트들은
비슷한 특징을 가지고 있어야 하므로, UMAP 축소 결과를
WSI 썸네일에 오버레이하여 특징들이 서로 다른 조직 영역으로
자연스럽게 분리되는지 확인할 수 있습니다. 이후,
위에서 생성한 패치 수준의 예측 맵과 함께 이를 시각화하여,
특징과 패치 수준 예측 간의 차이를 비교해보겠습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 먼저, UMAP 축소 계산을 위한 함수 정의</span>
<span class="k">def</span><span class="w"> </span><span class="nf">umap_reducer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nns</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;입력 데이터의 UMAP 축소&quot;&quot;&quot;</span>
    <span class="n">reducer</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">nns</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;manhattan&quot;</span><span class="p">,</span> <span class="n">spread</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">reduced</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">reduced</span> <span class="o">-=</span> <span class="n">reduced</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">reduced</span> <span class="o">/=</span> <span class="n">reduced</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reduced</span>

<span class="c1"># 특징 추출기에서 출력된 특징 불러오기</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">global_save_dir</span> <span class="o">/</span> <span class="s2">&quot;wsi_features&quot;</span> <span class="o">/</span> <span class="s2">&quot;0.position.npy&quot;</span><span class="p">)</span>
<span class="n">feats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">global_save_dir</span> <span class="o">/</span> <span class="s2">&quot;wsi_features&quot;</span> <span class="o">/</span> <span class="s2">&quot;0.features.0.npy&quot;</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">/</span> <span class="mi">8</span> <span class="c1"># 0.5mpp에서 특징을 추출하고, 4mpp에서 썸네일에 오버레이하기</span>

<span class="c1"># 특징을 3차원(RGB) 공간으로 축소하기</span>
<span class="n">reduced</span> <span class="o">=</span> <span class="n">umap_reducer</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>

<span class="c1"># 분류기의 예측 맵을 다시 그리기</span>
<span class="n">overlay</span> <span class="o">=</span> <span class="n">overlay_prediction_mask</span><span class="p">(</span>
    <span class="n">wsi_overview</span><span class="p">,</span>
    <span class="n">pred_map</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">label_info</span><span class="o">=</span><span class="n">label_color_dict</span><span class="p">,</span>
    <span class="n">return_ax</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 특징 맵 축소를 시각화하기</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wsi_overview</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">reduced</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;UMAP reduction of HistoEnc features&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img src="../_images/tiatoolbox_tutorial_004.png" srcset="../_images/tiatoolbox_tutorial_004.png" alt="tiatoolbox tutorial" class = "sphx-glr-multi-img"/></li>
<li><img src="../_images/tiatoolbox_tutorial_005.png" srcset="../_images/tiatoolbox_tutorial_005.png" alt="UMAP reduction of HistoEnc features" class = "sphx-glr-multi-img"/></li>
</ul>
<p>패치 수준 예측기(patch-level predictor)에서 생성된
예측 맵과 자가 지도 학습(self-supervised) 인코더를 통해 특징을
추출한 특징 맵이 WSI에서 조직 유형에 대한 유사한 정보를 포착하고
있음을 확인할 수 있습니다. 이는 모델이 예상대로 작동하고 있음을 확인할
수 있는 좋은 검증 방법입니다. 또한, HistoEncoder 모델이 추출한
특징들이 조직 유형 간의 차이를 잘 포착하고 있으며, 따라서 이 특징들이
조직학적으로 중요한 정보를 인코딩하고 있음을 보여줍니다.</p>
</section>
<section id="id12">
<h2>앞으로 해야할 것<a class="headerlink" href="#id12" title="Link to this heading">#</a></h2>
<p>이 노트북에서는 <code class="docutils literal notranslate"><span class="pre">PatchPredictor</span></code> 와
<code class="docutils literal notranslate"><span class="pre">DeepFeatureExtractor</span></code> 클래스의 <code class="docutils literal notranslate"><span class="pre">predict</span></code> 메소드를 사용하여
큰 타일(tiles)과 WSI의 패치에 대해 라벨을 예측하거나 특징을 추출하는 방법을 보여줍니다.
또한, 패치 예측 결과를 병합하고 입력 이미지/WSI에 예측 맵을
오버레이로 시각화하는 <code class="docutils literal notranslate"><span class="pre">merge_predictions</span></code> 와 <code class="docutils literal notranslate"><span class="pre">overlay_prediction_mask</span></code>
보조 함수도 소개합니다.</p>
<p>모든 과정은 TIAToolbox 내에서 이루어지며,
예제 코드를 따라 쉽게 구성할 수 있습니다.
입력값과 옵션을 올바르게 설정하는 것을 꼭 확인하세요.
또한 predict 함수의 매개변수를 변경했을 때
예측 결과에 미치는 영향을 탐구하는 것도 권장합니다.
TIAToolbox 프레임워크에서 제공하는 커뮤니티의 모델
또는 사용자 정의 사전 학습된 모델을 사용하여, TIAToolbox 모델 클래스에
정의되지 않은 구조의 모델이라도 대형 WSI에 대해 추론을 수행하는 방법을 시연했습니다.</p>
<p>다음 자료를 통해 더 많은 내용을 배울 수 있습니다:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://tia-toolbox.readthedocs.io/en/latest/_notebooks/jnb/07-advanced-modeling.html">PyTorch와 TIAToolbox를 통해 숙련된 모델
다루기</a></p></li>
<li><p><a class="reference external" href="https://tia-toolbox.readthedocs.io/en/latest/_notebooks/jnb/full-pipelines/slide-graph.html">커스텀 PyTorch 그래프 신경망을 사용하여 WSI(전체 슬라이드 이미지)에 대한 슬라이드 그래프
생성하기</a></p></li>
</ul>
</section>
</section>


                </article>
              
  </article>
  
              
              
                <footer class="bd-footer-article">
                  <div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item">
<div class="feedback">
  
<div class="rating">
    Rate this Page
    <div class="stars">
        
        <span class="star" data-behavior="tutorial-rating" data-count="1" data-value="1">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="2" data-value="2">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="3" data-value="3">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="4" data-value="4">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="5" data-value="5">★</span>
        
    </div>
</div>

  <div class="feedback-send">
    <button class="feedback-btn"
            onclick="openGitHubIssue()"
            data-bs-title="Create a GitHub Issue"
            data-bs-placement="bottom"
            data-bs-toggle="tooltip"
            data-gtm="feedback-btn-click">Send Feedback
    </button>
  </div>
</div>

<div class="prev-next-area">
</div>

<div class="footer-info">
  <p class="copyright">
    
      
        © Copyright 2018-2025, PyTorch &amp; 파이토치 한국 사용자 모임(PyTorchKR).
      
      <br/>
    
  </p>

  <p class="theme-version">
    Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
  </p>
</div>
</div>
  
</div>
                </footer>
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc">
<div class="sidebar-secondary-items sidebar-secondary__inner">
    
       <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">개요</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">환경설정</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">관련 라이브러리 불러오기</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up">실행 전 정리(clean-up)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">데이터 다운로드</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">데이터 읽기</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">이미지 패치 분류</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#patchpredictor"><code class="docutils literal notranslate"><span class="pre">PatchPredictor</span></code> 모델 정의하기</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">패치 라벨 예측하기</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#whole-slide">전체 슬라이드(whole slide)에 대한 패치 라벨 예측</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">병리학에 특화된 모델을 사용한 특징 추출</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">앞으로 해야할 것</a></li>
</ul>
  </nav></div>
    




<div class="sidebar-secondary-item">
  <div class="sidebar-heading">PyTorch Libraries</div>
  <ul style="list-style-type: none; padding: 0; padding-bottom: 80px;">
  
   <li><a class="nav-link nav-external" href="https://docs.pytorch.org/ao" style="color: var(--pst-color-text-muted)">torchao</a></li>
  
   <li><a class="nav-link nav-external" href="https://docs.pytorch.org/torchrec" style="color: var(--pst-color-text-muted)">torchrec</a></li>
  
   <li><a class="nav-link nav-external" href="https://docs.pytorch.org/torchft" style="color: var(--pst-color-text-muted)">torchft</a></li>
  
   <li><a class="nav-link nav-external" href="https://docs.pytorch.org/torchcodec" style="color: var(--pst-color-text-muted)">TorchCodec</a></li>
  
   <li><a class="nav-link nav-external" href="https://docs.pytorch.org/vision" style="color: var(--pst-color-text-muted)">torchvision</a></li>
  
   <li><a class="nav-link nav-external" href="https://docs.pytorch.org/executorch" style="color: var(--pst-color-text-muted)">ExecuTorch</a></li>
  
   <li><a class="nav-link nav-external" href="https://docs.pytorch.org/xla" style="color: var(--pst-color-text-muted)">PyTorch on XLA Devices</a></li>
  
  </ul>
</div>

</div>
</div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <div class="container-fluid docs-tutorials-resources">
  <div class="container">
    <div class="row">
      <div class="col-md-4 text-center">
        <h2>PyTorchKorea @ GitHub</h2>
        <p>파이토치 한국 사용자 모임을 GitHub에서 만나보세요.</p>
        <a class="with-right-arrow" href="https://github.com/PyTorchKorea">GitHub로 이동</a>
      </div>

      <div class="col-md-4 text-center">
        <h2>한국어 튜토리얼</h2>
        <p>한국어로 번역 중인 파이토치 튜토리얼을 만나보세요.</p>
        <a class="with-right-arrow" href="https://tutorials.pytorch.kr/">튜토리얼로 이동</a>
      </div>

      <div class="col-md-4 text-center">
        <h2>한국어 커뮤니티</h2>
        <p>다른 사용자들과 의견을 나누고, 도와주세요!</p>
        <a class="with-right-arrow" href="https://discuss.pytorch.kr/">커뮤니티로 이동</a>
      </div>
    </div>
  </div>
</div>

<footer class="site-footer">
  <div class="container footer-container">
    <div class="footer-logo-wrapper">
      <a href="https://pytorch.kr/" class="footer-logo"></a>
    </div>

    <div class="footer-links-wrapper">
      <div class="footer-links-col">
        <ul>
          <li class="list-title"><a href="https://pytorch.kr/">파이토치 한국 사용자 모임</a></li>
          <li><a href="https://pytorch.kr/about">사용자 모임 소개</a></li>
          <li><a href="https://pytorch.kr/contributors">기여해주신 분들</a></li>
          <li><a href="https://pytorch.kr/resources/">리소스</a></li>
          <li><a href="https://pytorch.kr/coc">행동 강령</a></li>
        </ul>
      </div>
    </div>

    <div class="trademark-disclaimer">
      <ul>
        <li>이 사이트는 독립적인 파이토치 사용자 커뮤니티로, 최신 버전이 아니거나 잘못된 내용이 포함되어 있을 수 있습니다. This site is an independent user community and may be out of date or contain incorrect information.</li>
        <li><a href="https://pytorch.kr/coc">행동 강령</a>을 읽고 지켜주세요. PyTorch 공식 로고 사용 규정은 <a href="https://www.linuxfoundation.org/policies/">Linux Foundation의 정책</a>을 따릅니다. Please read and follow <a href="https://pytorch.kr/coc">our code of conduct</a>. All PyTorch trademark policy applicable to <a href="https://www.linuxfoundation.org/policies/">Linux Foundation's policies</a>.</li>
      </ul>
    </div>
  </div>
</footer>

<div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../_static/img/pytorch-x.svg">
  </div>
</div>
  
  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2018-2025, PyTorch &amp; 파이토치 한국 사용자 모임(PyTorchKR).
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6 버전으로 생성되었습니다.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  <script type="application/ld+json">
    {
       "@context": "https://schema.org",
       "@type": "Article",
       "name": "Pytorch\uc640 TIAToolbox\ub97c \uc0ac\uc6a9\ud55c \uc804\uccb4 \uc2ac\ub77c\uc774\ub4dc \uc774\ubbf8\uc9c0(Whole Slide Image) \ubd84\ub958",
       "headline": "Pytorch\uc640 TIAToolbox\ub97c \uc0ac\uc6a9\ud55c \uc804\uccb4 \uc2ac\ub77c\uc774\ub4dc \uc774\ubbf8\uc9c0(Whole Slide Image) \ubd84\ub958",
       "description": "PyTorch Documentation. Explore PyTorch, an open-source machine learning library that accelerates the path from research prototyping to production deployment. Discover tutorials, API references, and guides to help you build and deploy deep learning models efficiently.",
       "url": "/intermediate/tiatoolbox_tutorial.html",
       "articleBody": "Pytorch\uc640 TIAToolbox\ub97c \uc0ac\uc6a9\ud55c \uc804\uccb4 \uc2ac\ub77c\uc774\ub4dc \uc774\ubbf8\uc9c0(Whole Slide Image) \ubd84\ub958# \ubc88\uc5ed: \ubc15\uc8fc\ud658 \ud301 \uc774 \ud29c\ud1a0\ub9ac\uc5bc\uc744 \ucd5c\ub300\ud55c \ud65c\uc6a9\ud558\ub824\uba74, \uc774 Colab \ubc84\uc804 \uc744 \uc0ac\uc6a9\ud558\ub294 \uac83\uc744 \uad8c\uc7a5\ud569\ub2c8\ub2e4. \uc774\ub97c \ud1b5\ud574 \uc544\ub798\uc758 \uc790\ub8cc\ub97c \uc2e4\ud5d8\ud574 \ubcfc \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uac1c\uc694# \ubcf8 \ud29c\ud1a0\ub9ac\uc5bc\uc5d0\uc11c\ub294 TIAToolbox\ub97c \uc0ac\uc6a9\ud55c PyTorch \ubaa8\ub378\uc744 \ud1b5\ud574 \uc804\uccb4 \uc2ac\ub77c\uc774\ub4dc \uc774\ubbf8\uc9c0\ub4e4(Whole Slide Images, WSIs)\uc744 \ubd84\ub958\ud558\ub294 \ubc29\ubc95\uc744 \uc54c\uc544\ubcf4\uaca0\uc2b5\ub2c8\ub2e4. WSI\ub780 \uc218\uc220\uc774\ub098 \uc0dd\uac80\uc744 \ud1b5\ud574 \ucc44\ucde8\ub41c \uc778\uac04 \uc870\uc9c1 \uc0d8\ud50c\uc758 \uc774\ubbf8\uc9c0\uc774\uba70, \uc774\ub7ec\ud55c \uc774\ubbf8\uc9c0\ub294 \uc804\ubb38 \uc2a4\uce90\ub108\ub97c \uc774\uc6a9\ud574 \uc2a4\uce94 \ub429\ub2c8\ub2e4. \uc774 \ub370\uc774\ud130\ub294 \ubcd1\ub9ac\ud559\uc790\uc640 \uc804\uc0b0 \ubcd1\ub9ac\ud559\uc790\ub4e4\uc774 \uc885\uc591 \uc131\uc7a5\uc5d0 \ub300\ud55c \uc774\ud574\ub97c \ub192\uc774\uace0 \ud658\uc790 \uce58\ub8cc\ub97c \uac1c\uc120\ud558\uae30 \uc704\ud574 \uc554\uacfc \uac19\uc740 \uc9c8\ubcd1\uc744 \ubbf8\uc2dc\uc801 \uc218\uc900\uc5d0\uc11c \uc5f0\uad6c \ud558\ub294\ub370 \uc0ac\uc6a9\ub429\ub2c8\ub2e4. WSIs\ub97c \ucc98\ub9ac\ud558\ub294 \uac83\uc774 \uc5b4\ub824\uc6b4 \uc774\uc720\ub294 \uc5c4\uccad\ub09c \ud06c\uae30 \ub54c\ubb38\uc785\ub2c8\ub2e4. \uc608\ucee8\ub300, \uc77c\ubc18\uc801\uc778 \uc2ac\ub77c\uc774\ub4dc \uc774\ubbf8\uc9c0\uac00 100,000x100,000 \ud53d\uc140 \uc815\ub3c4\uc758 \ud06c\uae30\ub97c \uac00\uc9c0\uba70, \uac01 \ud53d\uc140\uc740 \uc2ac\ub77c\uc774\ub4dc \uc0c1\uc5d0\uc11c \uc57d 0.25x0.25 \ub9c8\uc774\ud06c\ub85c\ubbf8\ud130\uc5d0 \ud574\ub2f9\ud569\ub2c8\ub2e4. \uc774 \ub54c\ubb38\uc5d0 \uc774\ubbf8\uc9c0\ub97c \ub85c\ub4dc\ud558\uace0 \ucc98\ub9ac\ud558\ub294 \ub370 \uc5b4\ub824\uc6c0\uc744 \uc57c\uae30\ud558\uba70, \ud55c \uc5f0\uad6c\uc5d0\uc11c \uc218\ubc31 \uac1c\ub098 \uc218\ucc9c \uac1c\uc758 WSIs\uac00 \ud3ec\ud568\ub418\ub294 \uacbd\uc6b0\ub294 \ub9d0\ud560 \uac83\ub3c4 \uc5c6\uc2b5\ub2c8\ub2e4 \ub354 \ud070 \uc5f0\uad6c\uac00 \ub354 \ub098\uc740 \uacb0\uacfc\ub97c \uc81c\uacf5\ud569\ub2c8\ub2e4! \uc804\ud1b5\uc801\uc778 \uc774\ubbf8\uc9c0 \ucc98\ub9ac \ud30c\uc774\ud504\ub77c\uc778\uc740 WSIs \ucc98\ub9ac\uc5d0 \uc801\ud569\ud558\uc9c0 \uc54a\uc73c\ubbc0\ub85c \ub354 \ub098\uc740 \ub3c4\uad6c\uac00 \ud544\uc694\ud569\ub2c8\ub2e4. \uc774\ub54c, TIAToolbox \uac00 \ub3c4\uc6c0\uc774 \ub420 \uc218 \uc788\ub294\ub370, \uc774\ub294 \uc870\uc9c1 \uc2ac\ub77c\uc774\ub4dc(tissue slides)\ub97c \ube60\ub974\uace0 \ud6a8\uc728\uc801\uc73c\ub85c \ucc98\ub9ac\ud560 \uc218 \uc788\ub294 \uc720\uc6a9\ud55c \ub3c4\uad6c\ub4e4\uc744 \uc81c\uacf5\ud569\ub2c8\ub2e4. \uc77c\ubc18\uc801\uc73c\ub85c WSIs\ub294 \uc2dc\uac01\ud654\uc5d0 \ucd5c\uc801\ud654\ub41c \ub2e4\uc591\ud55c \ubc30\uc728\uc5d0\uc11c \ub3d9\uc77c\ud55c \uc774\ubbf8\uc9c0\uc758 \uc5ec\ub7ec \ubcf5\uc0ac\ubcf8\uc774 \ud53c\ub77c\ubbf8\ub4dc \uad6c\uc870\ub85c \uc800\uc7a5\ub429\ub2c8\ub2e4. \ud53c\ub77c\ubbf8\ub4dc\uc758 \ub808\ubca8 0(\ub610\ub294 \uac00\uc7a5 \uc544\ub798 \ub2e8\uacc4)\uc5d0\ub294 \uac00\uc7a5 \ub192\uc740 \ubc30\uc728 \ub610\ub294 \uc90c \uc218\uc900\uc758 \uc774\ubbf8\uc9c0\ub97c \ud3ec\ud568\ud558\uba70, \ud53c\ub77c\ubbf8\ub4dc\uc758 \uc0c1\uc704 \ub2e8\uacc4\ub85c \uac08\uc218\ub85d \uae30\ubcf8 \uc774\ubbf8\uc9c0\uc758 \uc800 \ud574\uc0c1\ub3c4 \uc0ac\ubcf8\uc774 \uc788\uc2b5\ub2c8\ub2e4. \ud558\ub2e8\uc5d0 \ud53c\ub77c\ubbf8\ub4dc\uc758 \uad6c\uc870\uac00 \uadf8\ub824\uc838 \uc788\uc2b5\ub2c8\ub2e4. WSI \ud53c\ub77c\ubbf8\ub4dc stack (source) TIAToolbox\ub97c \uc0ac\uc6a9\ud558\uba74 \uc870\uc9c1 \ubd84\ub958 \uc640 \uac19\uc740 \uc77c\ubc18\uc801\uc778 \ud6c4\uc18d \ubd84\uc11d \uc791\uc5c5\uc744 \uc790\ub3d9\ud654\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \ubcf8 \ud29c\ud1a0\ub9ac\uc5bc\uc5d0\uc11c\ub294 \ub2e4\uc74c\uc744 \uc218\ud589\ud558\ub294 \ubc29\ubc95\uc744 \ubcf4\uc5ec\uc90d\ub2c8\ub2e4: 1. TIAToolbox\ub97c \uc0ac\uc6a9\ud558\uc5ec WSI(Whole Slide Image)\ub97c \uc774\ubbf8\uc9c0\ub97c \ub85c\ub4dc\ud558\ub294 \ubc29\ubc95 2. \uc11c\ub85c \ub2e4\ub978 Pytorch \ubaa8\ub378\uc744 \uc0ac\uc6a9\ud558\uc5ec \uc2ac\ub77c\uc774\ub4dc\ub97c \ud328\uce58 \ub808\ubca8(patch-level)\uc5d0\uc11c \ubd84\ub958\ud558\ub294 \ubc29\ubc95. \ubcf8 \ud29c\ud1a0\ub9ac\uc5bc\uc5d0\uc11c\ub294 TorchVision\uc758 ResNet18 \ubaa8\ub378\uacfc \ucee4\uc2a4\ud140(custom) HistoEncoder \ubaa8\ub378\uc744 \uc0ac\uc6a9\ud558\ub294 \uc608\uc81c\ub97c \uc81c\uacf5\ud569\ub2c8\ub2e4. \uc2dc\uc791\ud574\ubcf4\uc790! \ud658\uacbd\uc124\uc815# \ubcf8 \ud29c\ud1a0\ub9ac\uc5bc\uc5d0\uc11c \uc81c\uacf5\ud558\ub294 \uc608\uc81c\ub97c \uc2e4\ud589\ud558\ub824\uba74, \ub2e4\uc74c\uacfc \uac19\uc740 \ud328\ud0a4\uc9c0(packages)\uac00 \ud544\uc694\ud569\ub2c8\ub2e4. OpenJpeg OpenSlide Pixman TIAToolbox HistoEncoder (for a custom model example) \uc774 \ud328\ud0a4\uc9c0\ub4e4\uc744 \uc124\uce58\ud558\uae30 \uc704\ud574 \ud130\ubbf8\ub110(terminal)\uc5d0 \uc544\ub798\uc758 \uba85\ub839\uc5b4\ub97c \uc2e4\ud589\ud574\uc8fc\uc138\uc694: apt-get -y -qq install libopenjp2-7-dev libopenjp2-tools openslide-tools libpixman-1-dev pip install -q \u2018tiatoolbox\u003c1.5\u2019 histoencoder \u0026\u0026 echo \u201cInstallation is done.\u201d \ub610\ud55c, MacOS\uc5d0\uc11c\ub294 apt-get \ub300\uc2e0\uc5d0 brew install openjpeg openslide \uba85\ub839\uc5b4\ub97c \uc2e4\ud589\ud558\uc5ec \ud544\uc218 \ud328\ud0a4\uc9c0\ub4e4\uc744 \uc124\uce58\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc124\uce58\uc5d0 \ub300\ud55c \ucd94\uac00 \uc815\ubcf4\ub294 \uc5ec\uae30 \ub97c \ucc38\uc870\ud558\uc138\uc694. \uad00\ub828 \ub77c\uc774\ube0c\ub7ec\ub9ac \ubd88\ub7ec\uc624\uae30# \"\"\"Jupyter \ub178\ud2b8\ubd81\uc744 \uc2e4\ud589\ud558\ub294 \ub370 \ud544\uc694\ud55c \ubaa8\ub4c8 \ubd88\ub7ec\uc624\uae30.\"\"\" from __future__ import annotations # \ub85c\uae45(logging) \uc124\uc815\ud558\uae30 import logging import warnings if logging.getLogger().hasHandlers(): logging.getLogger().handlers.clear() warnings.filterwarnings(\"ignore\", message=\".*The \u0027nopython\u0027 keyword.*\") # \ub370\uc774\ud130\uc640 \ud30c\uc77c \ub2e4\uc6b4\ub85c\ub4dc\ud558\uae30 import shutil from pathlib import Path from zipfile import ZipFile # \ub370\uc774\ud130 \ucc98\ub9ac \ubc0f \uc2dc\uac01\ud654 import matplotlib as mpl import matplotlib.pyplot as plt import numpy as np import pandas as pd from matplotlib import cm import PIL import contextlib import io from sklearn.metrics import accuracy_score, confusion_matrix # WSI \ub85c\ub529 \ubc0f \ucc98\ub9ac\ub97c \uc704\ud55c TIAToolbox from tiatoolbox import logger from tiatoolbox.models.architecture import vanilla from tiatoolbox.models.engine.patch_predictor import ( IOPatchPredictorConfig, PatchPredictor, ) from tiatoolbox.utils.misc import download_data, grab_files_from_dir from tiatoolbox.utils.visualization import overlay_prediction_mask from tiatoolbox.wsicore.wsireader import WSIReader # Torch-\uad00\ub828 import torch from torchvision import transforms # \uadf8\ub798\ud504 \uc124\uc815 mpl.rcParams[\"figure.dpi\"] = 160 # for high resolution figure in notebook mpl.rcParams[\"figure.facecolor\"] = \"white\" # To make sure text is visible in dark mode # \ub9cc\uc57d GPU\ub97c \uc0ac\uc6a9\ud558\uc9c0 \uc54a\ub294\ub2e4\uba74, ON_GPU\ub97c False\ub85c \ubcc0\uacbd\ud558\uc138\uc694. ON_GPU = True # \uc7a5\ud669\ud55c \ucf54\ub4dc \ube14\ub85d\uc758 \ucf58\uc194 \ucd9c\ub825\uc744 \uc5b5\uc81c\ud558\ub294 \ud568\uc218 def suppress_console_output(): return contextlib.redirect_stderr(io.StringIO()) \uc2e4\ud589 \uc804 \uc815\ub9ac(clean-up)# \uc801\uc808\ud55c \uc815\ub9ac\ub97c \ubcf4\uc7a5\ud558\uae30 \uc704\ud574(\uc608\ucee8\ub300, \ube44\uc815\uc0c1 \uc885\ub8cc), \uc774\ubc88 \uc2e4\ud589\uc5d0\uc11c \ub2e4\uc6b4\ub85c\ub4dc\ub418\uac70\ub098 \uc0dd\uc131\ub41c \ubaa8\ub4e0 \ud30c\uc77c\uc740 global_save_dir \uc774\ub77c\ub294 \ud558\ub098\uc758 \ub514\ub809\ud1a0\ub9ac\uc5d0 \uc800\uc7a5\ub418\uba70, \uc774 \ub514\ub809\ud1a0\ub9ac\ub294 \u201c./tmp/\u201d\ub85c \uc124\uc815\ub429\ub2c8\ub2e4. \uc720\uc9c0\ubcf4\uc218\ub97c \uc27d\uac8c \ud558\uae30 \uc704\ud574 \ub514\ub809\ud1a0\ub9ac \uc774\ub984\uc740 \uc774 \ud55c \uacf3\uc5d0\uc11c\ub9cc \uc124\uc815\ub418\ubbc0\ub85c, \ud544\uc694\ud558\uba74 \uac04\ud3b8\ud558\uac8c \ubcc0\uacbd\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. warnings.filterwarnings(\"ignore\") global_save_dir = Path(\"./tmp/\") def rmdir(dir_path: str | Path) -\u003e None: \"\"\"\ub514\ub809\ud1a0\ub9ac\ub97c \uc9c0\uc6b0\uae30 \uc704\ud55c \ub3c4\uc6b0\ubbf8 \ud568\uc218\"\"\" if Path(dir_path).is_dir(): shutil.rmtree(dir_path) logger.info(\"Removing directory %s\", dir_path) rmdir(global_save_dir) # \uc774\uc804 \uc2e4\ud589\uc5d0\uc11c \ub514\ub809\ud1a0\ub9ac\uac00 \uc788\ub294 \uacbd\uc6b0 \uc0ad\uc81c global_save_dir.mkdir() logger.info(\"Creating new directory %s\", global_save_dir) \ub370\uc774\ud130 \ub2e4\uc6b4\ub85c\ub4dc# \uc0d8\ud50c \ub370\uc774\ud130\ub85c\ub294 \uc804\uccb4 \uc2ac\ub77c\uc774\ub4dc \uc774\ubbf8\uc9c0(whole-slide image)\ub97c \uc0ac\uc6a9\ud558\uace0 Kather 100k \ub370\uc774\ud130\uc14b\uc758 \uac80\uc99d(validation) \ud558\uc704 \uc9d1\ub2e8(subset)\uc5d0\uc11c \ucd94\ucd9c\ud55c \ud328\uce58\ub4e4\uc744 \uc0ac\uc6a9\ud560 \uac83\uc785\ub2c8\ub2e4. wsi_path = global_save_dir / \"sample_wsi.svs\" patches_path = global_save_dir / \"kather100k-validation-sample.zip\" weights_path = global_save_dir / \"resnet18-kather100k.pth\" logger.info(\"Download has started. Please wait...\") # \uc804\uccb4 \uc2ac\ub77c\uc774\ub4dc \uc774\ubbf8\uc9c0(whole-slide image) \uc0d8\ud50c\uc744 \ub2e4\uc6b4\ub85c\ub4dc \ud558\uace0 \uc555\ucd95\uc744 \ud574\uc81c\ud558\uae30 download_data( \"https://tiatoolbox.dcs.warwick.ac.uk/sample_wsis/TCGA-3L-AA1B-01Z-00-DX1.8923A151-A690-40B7-9E5A-FCBEDFC2394F.svs\", wsi_path, ) # Kather 100K \ub370\uc774\ud130\uc14b\uc744 \ud6c8\ub828\ud558\uae30 \uc704\ud574 \uc0ac\uc6a9\ub41c \uac80\uc99d \uc138\ud2b8(validation set) \uc0d8\ud50c\uc744 \ub2e4\uc6b4\ub85c\ub4dc\ud558\uace0 \uc555\ucd95\uc744 \ud574\uc81c\ud558\uae30 download_data( \"https://tiatoolbox.dcs.warwick.ac.uk/datasets/kather100k-validation-sample.zip\", patches_path, ) with ZipFile(patches_path, \"r\") as zipfile: zipfile.extractall(path=global_save_dir) # ResNet18 \uc544\ud0a4\ud14d\ucc98\ub85c WSI(\uc804\uccb4 \uc2ac\ub77c\uc774\ub4dc \uc774\ubbf8\uc9c0) \ubd84\ub958\ub97c \uc704\ud574 \uc0ac\uc804 \ud559\uc2b5\ub41c \ubaa8\ub378 \uac00\uc911\uce58\ub97c \ub2e4\uc6b4\ub85c\ub4dc\ud558\uae30 download_data( \"https://tiatoolbox.dcs.warwick.ac.uk/models/pc/resnet18-kather100k.pth\", weights_path, ) logger.info(\"Download is complete.\") \ub370\uc774\ud130 \uc77d\uae30# \ud328\uce58 \ubaa9\ub85d\uacfc \ud574\ub2f9\ub418\ub294 \ub77c\ubca8 \ubaa9\ub85d\uc744 \uc0dd\uc131\ud569\ub2c8\ub2e4. \uc608\ub97c \ub4e4\uc5b4, label_list \uc758 \uccab \ubc88\uc9f8 \ub77c\ubca8\uc740 patch_list \uc758 \uccab \ubc88\uc9f8 \uc774\ubbf8\uc9c0 \ud328\uce58\uc758 \ud074\ub798\uc2a4\ub97c \ub098\ud0c0\ub0c5\ub2c8\ub2e4. # \ud328\uce58 \ub370\uc774\ud130\ub97c \uc77d\uace0 \ud328\uce58 \ubaa9\ub85d\uacfc \ud574\ub2f9 \ub77c\ubca8 \ubaa9\ub85d\uc744 \uc0dd\uc131 dataset_path = global_save_dir / \"kather100k-validation-sample\" # \ub370\uc774\ud130\uc14b \uacbd\ub85c \uc124\uc815 image_ext = \".tif\" # \uac01 \uc774\ubbf8\uc9c0\uc758 \ud30c\uc77c \ud655\uc7a5\uc790 # \ub77c\ubca8 ID\uc640 \ud074\ub798\uc2a4 \uc774\ub984 \uac04\uc758 \ub9e4\ud551 label_dict = { \"BACK\": 0, # Background (empty glass region) # \uc774 \ubd80\ubd84\uc740 \ubc11\uc5d0\uc11c \uc790\uc138\ud788 \uc124\uba85 \"NORM\": 1, # Normal colon mucosa \"DEB\": 2, # Debris \"TUM\": 3, # Colorectal adenocarcinoma epithelium \"ADI\": 4, # Adipose \"MUC\": 5, # Mucus \"MUS\": 6, # Smooth muscle \"STR\": 7, # Cancer-associated stroma \"LYM\": 8, # Lymphocytes } class_names = list(label_dict.keys()) class_labels = list(label_dict.values()) # \ud328\uce58 \ubaa9\ub85d \uc0dd\uc131 \ubc0f \ud30c\uc77c \uc774\ub984\uc5d0\uc11c \ub77c\ubca8 \ucd94\ucd9c\ud558\uae30 patch_list = [] label_list = [] for class_name, label in label_dict.items(): dataset_class_path = dataset_path / class_name patch_list_single_class = grab_files_from_dir( dataset_class_path, file_types=\"*\" + image_ext, ) patch_list.extend(patch_list_single_class) label_list.extend([label] * len(patch_list_single_class)) # \ub370\uc774\ud130\uc14b \ud1b5\uacc4 \ud45c\uae30 plt.bar(class_names, [label_list.count(label) for label in class_labels]) plt.xlabel(\"Patch types\") plt.ylabel(\"Number of patches\") # \ud074\ub798\uc2a4\ubcc4 \uc608\uc2dc \uac1c\uc218 \uc9d1\uacc4 for class_name, label in label_dict.items(): logger.info( \"Class ID: %d -- Class Name: %s -- Number of images: %d\", label, class_name, label_list.count(label), ) # \uc804\uccb4 \ub370\uc774\ud130\uc14b \ud1b5\uacc4 logger.info(\"Total number of patches: %d\", (len(patch_list))) |2023-11-14|13:15:59.299| [INFO] Class ID: 0 -- Class Name: BACK -- Number of images: 211 |2023-11-14|13:15:59.299| [INFO] Class ID: 1 -- Class Name: NORM -- Number of images: 176 |2023-11-14|13:15:59.299| [INFO] Class ID: 2 -- Class Name: DEB -- Number of images: 230 |2023-11-14|13:15:59.299| [INFO] Class ID: 3 -- Class Name: TUM -- Number of images: 286 |2023-11-14|13:15:59.299| [INFO] Class ID: 4 -- Class Name: ADI -- Number of images: 208 |2023-11-14|13:15:59.299| [INFO] Class ID: 5 -- Class Name: MUC -- Number of images: 178 |2023-11-14|13:15:59.299| [INFO] Class ID: 6 -- Class Name: MUS -- Number of images: 270 |2023-11-14|13:15:59.299| [INFO] Class ID: 7 -- Class Name: STR -- Number of images: 209 |2023-11-14|13:15:59.299| [INFO] Class ID: 8 -- Class Name: LYM -- Number of images: 232 |2023-11-14|13:15:59.299| [INFO] Total number of patches: 2000 \uc774 \ud328\uce58 \ub370\uc774\ud130\uc14b\uc5d0\uc11c \ubcfc \uc218 \uc788\ub4ef\uc774, 0\ubd80\ud130 8\uae4c\uc9c0\uc758 ID\ub97c \uac00\uc9c4 9\uac1c\uc758 \ud074\ub798\uc2a4\uc640 \ub77c\ubca8\uc774 \uc788\uc73c\uba70, \uac01 \ud074\ub798\uc2a4\ub294 \ud574\ub2f9 \ud328\uce58\uc5d0\uc11c \uc8fc\ub85c \ub098\ud0c0\ub098\ub294 \uc870\uc9c1 \uc720\ud615\uc744 \uc124\uba85\ud569\ub2c8\ub2e4: BACK \u27f6 \ubc30\uacbd(Background)(\ube44\uc5b4 \uc788\ub294 \uc601\uc5ed) LYM \u27f6 \ub9bc\ud504\uad6c(Lymphocytes) NORM \u27f6 \uc815\uc0c1 \ub300\uc7a5 \uc810\ub9c9(Normal colon mucosa) DEB \u27f6 \uc870\uc9c1 \ud30c\ud3b8(Debris) MUS \u27f6 \ud3c9\ud65c\uadfc(Smooth muscle) STR \u27f6 \uc554 \uad00\ub828 \uae30\uc9c8(Cancer-associated stroma) ADI \u27f6 \uc9c0\ubc29 \uc870\uc9c1(Adipose) MUC \u27f6 \uc810\uc561(Mucus) TUM \u27f6 \ub300\uc7a5\uc120\uc554 \uc0c1(Colorectal adenocarcinoma epithelium) \uc774\ubbf8\uc9c0 \ud328\uce58 \ubd84\ub958# \uba3c\uc800 patch \ubaa8\ub4dc\ub97c \uc0ac\uc6a9\ud558\uc5ec \ub514\uc9c0\ud138 \uc2ac\ub77c\uc774\ub4dc \ub0b4\uc758 \uac01 \ud328\uce58\uc5d0 \ub300\ud55c \uc608\uce21\uc744 \uad6c\ud558\ub294 \ubc29\ubc95\uc744 \uc2dc\uc5f0\ud55c \ud6c4, wsi \ubaa8\ub4dc\ub97c \uc0ac\uc6a9\ud558\uc5ec \ud070(large) \uc2ac\ub77c\uc774\ub4dc\uc5d0 \ub300\ud574 \uc608\uce21\uc744 \uc218\ud589\ud558\ub294 \ubc29\ubc95\uc744 \ubcf4\uc5ec\uc90d\ub2c8\ub2e4. PatchPredictor \ubaa8\ub378 \uc815\uc758\ud558\uae30# PatchPredictor \ud074\ub798\uc2a4\ub294 PyTorch\ub85c \uc791\uc131\ub41c CNN \uae30\ubc18 \ubd84\ub958\uae30\ub97c \uc2e4\ud589\ud569\ub2c8\ub2e4 \ubaa8\ub378 \uc740 tiatoolbox.models.abc.ModelABC `(\ubb38\uc11c)\u003chttps://tia-toolbox.readthedocs.io/en/latest/_autosummary/tiatoolbox.models.models_abc.ModelABC.html\u003e`__ \ud074\ub798\uc2a4 \uad6c\uc870\ub97c \ub530\ub974\ub294 \ubaa8\ub4e0 PyTorch\ub85c \ud6c8\ub828\ub41c \ubaa8\ub378\uc744 \uc0ac\uc6a9\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc774\uc5d0 \ub300\ud55c \uc790\uc138\ud55c \ub0b4\uc6a9\uc740 \uace0\uae09 \ubaa8\ub378 \uae30\uc220\uc5d0 \uad00\ud55c \uc608\uc81c \ub178\ud2b8\ubd81(notebook). \uc744 \ucc38\uc870\ud558\uc2ed\uc2dc\uc624. \ucee4\uc2a4\ud140 \ubaa8\ub378\uc744 \ub85c\ub4dc\ud558\ub824\uba74, preproc_func(img) \uc640 \uac19\uc740 \uc804\ucc98\ub9ac \ud568\uc218\ub97c \uc791\uc131\ud574\uc57c \ud558\uba70, \uc774 \ud568\uc218\ub294 \uc785\ub825 tensor\uac00 \ub85c\ub4dc\ub41c \ub124\ud2b8\uc6cc\ud06c\uc5d0 \uc801\ud569\ud55c \ud615\uc2dd\uc73c\ub85c \ub418\uc5b4 \uc788\ub294\uc9c0 \ud655\uc778\ud574\uc90d\ub2c8\ub2e4. \ub610\ud55c, \uc0ac\uc804 \ud559\uc2b5\ub41c \ubaa8\ub378(pretrained_model) \uc744 \ubb38\uc790\uc5f4 \uc778\uc218\ub85c \uc804\ub2ec\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc774\ub294 \uc608\uce21\uc744 \uc218\ud589\ud560 CNN \ubaa8\ub378\uc744 \uc9c0\uc815\ud558\uba70, \ud574\ub2f9 \ubaa8\ub378\uc740 \uc5ec\uae30 \ub098\uc5f4\ub41c \ubaa8\ub378 \uc911 \ud558\ub098\uc774\uc5b4\uc57c \ud569\ub2c8\ub2e4. \uba85\ub839\uc5b4\ub294 \ub2e4\uc74c\uacfc \uac19\uc2b5\ub2c8\ub2e4: predictor = PatchPredictor(pretrained_model=\u0027resnet18-kather100k\u0027, pretrained_weights=weights_path, batch_size=32) . pretrained_weights : \uc0ac\uc804 \ud559\uc2b5\ub41c \ubaa8\ub378(pretrained_model) \uc744 \uc0ac\uc6a9\ud560 \ub54c, \ud574\ub2f9 \ubaa8\ub378\uc758 \uc0ac\uc804 \ud559\uc2b5\ub41c \uac00\uc911\uce58\ub3c4 \uae30\ubcf8\uc801\uc73c\ub85c \ub2e4\uc6b4\ub85c\ub4dc \ub429\ub2c8\ub2e4. \uae30\ubcf8\uc73c\ub85c \uc81c\uacf5\ub418\ub294 \uac00\uc911\uce58\ub97c \ub36e\uc5b4\uc4f0\uace0 \uc790\uc2e0\ub9cc\uc758 \uac00\uc911\uce58\ub97c \uc0ac\uc6a9\ud558\ub824\uba74 pretrained_weight \uc778\uc218\ub97c \ud1b5\ud574 \uac00\uc911\uce58\ub97c \uc9c0\uc815\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. batch_size : \ubaa8\ub378\uc5d0 \ud55c \ubc88\uc5d0 \uc785\ub825\ub418\ub294 \uc774\ubbf8\uc9c0\uc758 \uac1c\uc218\ub97c \uc9c0\uc815\ud569\ub2c8\ub2e4. \uc774 \uac12\uc774 \ud074\uc218\ub85d \ub354 \ub9ce\uc740 (GPU)\uba54\ubaa8\ub9ac \uc6a9\ub7c9\uc774 \ud544\uc694\ud569\ub2c8\ub2e4. # TIAToolbox\uc5d0\uc11c \uc0ac\uc804 \ud559\uc2b5\ub41c PyTorch \ubaa8\ub378 \uac00\uc838\uc624\uae30 predictor = PatchPredictor(pretrained_model=\u0027resnet18-kather100k\u0027, batch_size=32) # \uc0ac\uc6a9\uc790\ub294 \uc544\ub798 \uc2a4\ud06c\ub9bd\ud2b8\ub97c \ud1b5\ud574 \uc6d0\ud558\ub294 PyTorch \ubaa8\ub378 \uc544\ud0a4\ud14d\ucc98\ub97c \ubd88\ub7ec\uc62c \uc218 \uc788\uc2b5\ub2c8\ub2e4. model = vanilla.CNNModel(backbone=\"resnet18\", num_classes=9) # torchvision.models.resnet18\uc5d0\uc11c \ubaa8\ub378 \ubd88\ub7ec\uc624\uae30 model.load_state_dict(torch.load(weights_path, map_location=\"cpu\", weights_only=True), strict=True) def preproc_func(img): img = PIL.Image.fromarray(img) img = transforms.ToTensor()(img) return img.permute(1, 2, 0) model.preproc_func = preproc_func predictor = PatchPredictor(model=model, batch_size=32) \ud328\uce58 \ub77c\ubca8 \uc608\uce21\ud558\uae30# \uc608\uce21\uae30(predictor) \uac1d\uccb4\ub97c \uc0dd\uc131\ud55c \ud6c4 patch \ubaa8\ub4dc\ub97c \uc0ac\uc6a9\ud558\uc5ec predict \uba54\uc18c\ub4dc\ub97c \ud638\ucd9c\ud569\ub2c8\ub2e4. \uadf8\ub7f0 \ub2e4\uc74c, \ubd84\ub958 \uc815\ud655\ub3c4\uc640 \uc624\ucc28 \ud589\ub82c(confusion matrix)\uc744 \uacc4\uc0b0\ud569\ub2c8\ub2e4. with suppress_console_output(): output = predictor.predict(imgs=patch_list, mode=\"patch\", on_gpu=ON_GPU) acc = accuracy_score(label_list, output[\"predictions\"]) logger.info(\"Classification accuracy: %f\", acc) # \ud328\uce58 \ubd84\ub958 \uacb0\uacfc\ub97c \uc704\ud55c \uc624\ucc28 \ud589\ub82c(confusion_matrix) \uc0dd\uc131 \ubc0f \uc2dc\uac01\ud654 conf = confusion_matrix(label_list, output[\"predictions\"], normalize=\"true\") df_cm = pd.DataFrame(conf, index=class_names, columns=class_names) df_cm |2023-11-14|13:16:03.215| [INFO] Classification accuracy: 0.993000 .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } BACK NORM DEB TUM ADI MUC MUS STR LYM BACK 1.000000 0.000000 0.000000 0.000000 0.000000 0.000000 0.000000 0.000000 0.00000 NORM 0.000000 0.988636 0.000000 0.011364 0.000000 0.000000 0.000000 0.000000 0.00000 DEB 0.000000 0.000000 0.991304 0.000000 0.000000 0.000000 0.000000 0.008696 0.00000 TUM 0.000000 0.000000 0.000000 0.996503 0.000000 0.003497 0.000000 0.000000 0.00000 ADI 0.004808 0.000000 0.000000 0.000000 0.990385 0.000000 0.004808 0.000000 0.00000 MUC 0.000000 0.000000 0.000000 0.000000 0.000000 0.988764 0.000000 0.011236 0.00000 MUS 0.000000 0.000000 0.000000 0.000000 0.000000 0.000000 0.996296 0.003704 0.00000 STR 0.000000 0.000000 0.004785 0.000000 0.000000 0.004785 0.004785 0.985646 0.00000 LYM 0.000000 0.000000 0.000000 0.000000 0.000000 0.000000 0.000000 0.004310 0.99569 \uc804\uccb4 \uc2ac\ub77c\uc774\ub4dc(whole slide)\uc5d0 \ub300\ud55c \ud328\uce58 \ub77c\ubca8 \uc608\uce21# IOPatchPredictorConfig \ud074\ub798\uc2a4\ub97c \uc18c\uac1c\ud569\ub2c8\ub2e4. \uc774 \ud074\ub798\uc2a4\ub294 \ubaa8\ub378 \uc608\uce21 \uc5d4\uc9c4\uc744 \uc704\ud55c \uc774\ubbf8\uc9c0 \uc77d\uae30 \ubc0f \uc608\uce21 \uacb0\uacfc \uc4f0\uae30 \uad6c\uc131 \uc124\uc815\uc744 \uc9c0\uc815\ud569\ub2c8\ub2e4. \uc774 \uc124\uc815\uc740 \ubd84\ub958\uae30(classifier)\uc5d0\uac8c WSI \ud53c\ub77c\ubbf8\ub4dc\uc758 \uc5b4\ub290 \ub808\ubca8\uc744 \uc77d\uace0, \ub370\uc774\ud130\ub97c \ucc98\ub9ac\ud558\uba70, \ucd9c\ub825\uc744 \uc0dd\uc131\ud574\uc57c \ud558\ub294\uc9c0 \uc54c\ub824\uc8fc\ub294 \ub370 \ud544\uc218\uc801\uc785\ub2c8\ub2e4. IOPatchPredictorConfig \uc758 \ub9e4\uac1c\ubcc0\uc218\ub294 \ub2e4\uc74c\uacfc \uac19\uc774 \uc815\uc758\ub429\ub2c8\ub2e4. input_resolutions: \uc785\ub825\uc758 \ud574\uc0c1\ub3c4\ub97c \uc9c0\uc815\ud558\ub294 \ub515\uc154\ub108\ub9ac \ud615\ud0dc\uc758 \ub9ac\uc2a4\ud2b8\ub85c, \uac01 \uc785\ub825\uc758 \ud574\uc0c1\ub3c4\ub97c \uc124\uc815\ud569\ub2c8\ub2e4. \ub9ac\uc2a4\ud2b8\uc758 \uc694\uc18c\ub294 model.forward() \uc758 \uc21c\uc11c\uc640 \uac19\uc544\uc57c\ud569\ub2c8\ub2e4. \ub9cc\uc57d \ubaa8\ub378\uc774 \ud558\ub098\uc758 \uc785\ub825\ub9cc \ubc1b\ub294 \uacbd\uc6b0, \ud558\ub098\uc758 \ub515\uc154\ub108\ub9ac\ub85c \u0027units\u0027 \uc640 \u0027resolution\u0027 \uc744 \uc9c0\uc815\ud558\uba74 \ub429\ub2c8\ub2e4. TIAToolbox\ub294 \ud558\ub098 \uc774\uc0c1\uc758 \uc785\ub825\uc744 \ubc1b\ub294 \ubaa8\ub378\uc744 \uc9c0\uc6d0\ud558\ubbc0\ub85c, \uc5ec\ub7ec \uc785\ub825\uc744 \uc0ac\uc6a9\ud558\ub294 \uacbd\uc6b0\uc5d0\ub3c4 \ubb38\uc81c\uc5c6\uc774 \uc0ac\uc6a9\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc720\ub2db(units)\uacfc \ud574\uc0c1\ub3c4(resolution)\uc5d0 \ub300\ud55c \uc790\uc138\ud55c \ub0b4\uc6a9\uc740 TIAToolbox \ubb38\uc11c \ub97c \ucc38\uace0\ud558\uc2ed\uc2dc\uc624. patch_input_shape: \uac00\uc7a5 \ud070 \uc785\ub825\uc758 \ud06c\uae30\ub97c (\ub192\uc774, \ub108\ube44) \ud615\uc2dd\uc73c\ub85c \uc9c0\uc815\ud569\ub2c8\ub2e4. stride_shape: \uc5f0\uc18d\ub41c \ub450 \ud328\uce58 \uc0ac\uc774\uc758 \uac04\uaca9(\ub2e8\uacc4) \ud06c\uae30\ub97c \uc9c0\uc815\ud558\uba70, \ud328\uce58 \ucd94\ucd9c \uacfc\uc815\uc5d0\uc11c \uc0ac\uc6a9\ub429\ub2c8\ub2e4. \uc0ac\uc6a9\uc790\uac00 stride_shape \ub97c patch_input_shape \uc640 \ub3d9\uc77c\ud558\uac8c \uc124\uc815\ud558\uba74, \ud328\uce58\ub4e4\uc774 \uc911\ucca9\uc5c6\uc774 \ucd94\ucd9c\ub418\uace0, \ucc98\ub9ac\ub429\ub2c8\ub2e4. wsi_ioconfig = IOPatchPredictorConfig( input_resolutions=[{\"units\": \"mpp\", \"resolution\": 0.5}], patch_input_shape=[224, 224], stride_shape=[224, 224], ) predict \uba54\uc18c\ub4dc\ub294 \uc785\ub825 \ud328\uce58\uc5d0 CNN\uc744 \uc801\uc6a9\ud558\uc5ec \uacb0\uacfc\ub97c \uc5bb\uc2b5\ub2c8\ub2e4. \ub2e4\uc74c\uc740 \ud574\ub2f9 \uba54\uc18c\ub4dc\uc758 \uc778\uc218\uc640 \uc124\uba85\uc785\ub2c8\ub2e4: mode: \ucc98\ub9ac\ud560 \uc785\ub825\uc758 \uc720\ud615\uc744 \uc9c0\uc815\ud569\ub2c8\ub2e4. \uc751\uc6a9 \ud504\ub85c\uadf8\ub7a8\uc5d0 \ub530\ub77c patch, tile \ub610\ub294 wsi \uc911\uc5d0\uc11c \uc120\ud0dd\ud569\ub2c8\ub2e4. imgs: \uc785\ub825 \ud30c\uc77c\ub4e4\uc758 \uacbd\ub85c \ub9ac\uc2a4\ud2b8\ub85c, \uc785\ub825 \ud0c0\uc77c(input tiles) \ub610\ub294 WSIs \uacbd\ub85c\uc758 \ubaa9\ub85d\uc774\uc5b4\uc57c \ud569\ub2c8\ub2e4. return_probabilities: \uc785\ub825 \ud328\uce58\uc758 \uc608\uce21\ub41c \ub77c\ubca8\uacfc \ud568\uaed8 \ud074\ub798\uc2a4\ubcc4 \ud655\ub960\uc744 \uc5bb\uc73c\ub824\uba74 True \ub85c \uc124\uc815\ud569\ub2c8\ub2e4. tile \ub610\ub294 wsi \ubaa8\ub4dc\uc5d0\uc11c \uc608\uce21 \uacb0\uacfc\ub97c \ubcd1\ud569\ud558\uc5ec \uc608\uce21 \ub9f5\uc744 \uc0dd\uc131\ud558\ub824\uba74 return_probabilities=True \ub85c \uc124\uc815\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. ioconfig: IOPatchPredictorConfig \ud074\ub798\uc2a4\ub97c \uc0ac\uc6a9\ud558\uc5ec IO \uad6c\uc131 \uc815\ubcf4\ub97c \uc124\uc815\ud569\ub2c8\ub2e4. resolution \uacfc unit (\uc544\ub798\uc5d0 \ud45c\uc2dc\ub418\uc9c0 \uc54a\uc74c): \ucd94\ucd9c\ud560 \ud328\uce58\uc758 WSI \ub808\ubca8 \ub610\ub294 \ub9c8\uc774\ud06c\ub860\ub2f9 \ud53d\uc140 \ud574\uc0c1\ub3c4\ub97c \uc9c0\uc815\ud569\ub2c8\ub2e4. \uc774\ub294 ioconfig \ub300\uc2e0 \uc0ac\uc6a9\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc5ec\uae30\uc11c WSI \ub808\ubca8\uc740 \u0027baseline\u0027 \uc73c\ub85c \uc9c0\uc815\ud558\uba70, \uc774\ub294 \uc77c\ubc18\uc801\uc73c\ub85c \ub808\ubca8 0\uc5d0 \uc774 \uacbd\uc6b0 \uc774\ubbf8\uc9c0\ub294 \ud558\ub098\uc758 \ub808\ubca8\ub9cc \uac00\uc9c0\uace0 \uc788\uc2b5\ub2c8\ub2e4. \ub354 \uc790\uc138\ud55c \ub0b4\uc6a9\uc740 \ubb38\uc11c \uc5d0\uc11c \ud655\uc778\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. masks: imgs \ub9ac\uc2a4\ud2b8\uc5d0 \uc788\ub294 WSI\uc758 \ub9c8\uc2a4\ud06c \uacbd\ub85c \ub9ac\uc2a4\ud2b8\uc785\ub2c8\ub2e4. \uc774 \ub9c8\uc2a4\ud06c\ub294 \uc6d0\ubcf8 WSI\uc5d0\uc11c \ud328\uce58\ub97c \ucd94\ucd9c\ud558\uace0\uc790 \ud558\ub294 \uc601\uc5ed\uc744 \uc9c0\uc815\ud569\ub2c8\ub2e4. \ud2b9\uc815 WSI\uc758 \ub9c8\uc2a4\ud06c\uac00 None \uc73c\ub85c \uc9c0\uc815\ub418\uba74, \ud574\ub2f9 WSI\uc758 \ubaa8\ub4e0 \ud328\uce58(\ubc30\uacbd \uc601\uc5ed \ud3ec\ud568)\uc5d0 \ub300\ud55c \ub77c\ubca8\uc774 \uc608\uce21\ub429\ub2c8\ub2e4. \uc774\ub294 \ubd88\ud544\uc694\ud55c \uacc4\uc0b0\uc744 \uc720\ubc1c\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. merge_predictions: \ud328\uce58 \ubd84\ub958 \uacb0\uacfc\ub97c 2D \ub9f5\uc73c\ub85c \uc0dd\uc131\ud574\uc57c\ud558\ub294 \uacbd\uc6b0 True \ub85c \uc124\uc815\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uadf8\ub7ec\ub098 \ud070 WSI\uc758 \uacbd\uc6b0 \ub9ce\uc740 \uba54\ubaa8\ub9ac\uac00 \ud544\uc694\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \ub300\uc548\uc801\uc778 \ud574\uacb0\ucc45\uc73c\ub85c\ub294 merge_predictions=False \ub85c(\uae30\ubcf8\uac12) \uc124\uc815\ud558\uc5ec, \ucd94\ud6c4\uc5d0 merge_predictions \ud568\uc218\ub97c \uc0ac\uc6a9\ud574 2D \uc608\uce21 \ub9f5\uc744 \uc0dd\uc131\ud558\ub294 \ubc29\ubc95\uc744 \uc0ac\uc6a9\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \ud070 WSI\ub97c \uc0ac\uc6a9\ud558\uace0 \uc788\uae30 \ub54c\ubb38\uc5d0 \ud328\uce58 \ucd94\ucd9c \ubc0f \uc608\uce21 \uacfc\uc815\uc5d0 \uc2dc\uac04\uc774 \ub2e4\uc18c \uac78\ub9b4 \uc218 \uc788\uc2b5\ub2c8\ub2e4. (\ub9cc\uc57d Cuda\uac00 \ud65c\uc131\ud654\ub41c GPU\ub97c \uc0ac\uc6a9\ud560 \uc218 \uc788\ub2e4\uba74 ON_GPU=True \ub85c \uc124\uc815\ud558\uc5ec PyTorch\uc640 Cuda\ub97c \ud65c\uc6a9\ud558\ub294 \uac83\uc774 \uc88b\uc2b5\ub2c8\ub2e4). with suppress_console_output(): wsi_output = predictor.predict( imgs=[wsi_path], masks=None, mode=\"wsi\", merge_predictions=False, ioconfig=wsi_ioconfig, return_probabilities=True, save_dir=global_save_dir / \"wsi_predictions\", on_gpu=ON_GPU, ) wsi_output \uc744 \uc2dc\uac01\ud654\ud558\uc5ec \uc608\uce21 \ubaa8\ub378\uc774 \uc804\uccb4 \uc2ac\ub77c\uc774\ub4dc \uc774\ubbf8\uc9c0(WSI)\uc5d0\uc11c \uc5b4\ub5bb\uac8c \uc791\ub3d9\ud558\ub294\uc9c0 \ud655\uc778\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uba3c\uc800 \ud328\uce58 \uc608\uce21 \uacb0\uacfc\ub97c \ubcd1\ud569\ud55c \ud6c4, \uc774\ub97c \uc6d0\ubcf8 \uc774\ubbf8\uc9c0 \uc704\uc5d0 \uc624\ubc84\ub808\uc774\ub85c \uc2dc\uac01\ud654\ud574\uc57c \ud569\ub2c8\ub2e4. \uc774\uc804\uacfc \ub9c8\ucc2c\uac00\uc9c0\ub85c merge_predictions \uba54\uc18c\ub4dc\ub97c \uc0ac\uc6a9\ud558\uc5ec \ud328\uce58 \uc608\uce21\uc744 \ubcd1\ud569\ud569\ub2c8\ub2e4. \uc774\ub54c, 1.25x \ub9cc\ud07c \ud655\ub300\ub41c \uc608\uce21 \ub9f5\uc744 \uc0dd\uc131\ud558\uae30 \uc704\ud574 resolution=1.25, units=\u0027power\u0027 \ub85c \ub9e4\uac1c\ubcc0\uc218\ub97c \uc124\uc815\ud569\ub2c8\ub2e4. \ub9cc\uc57d \ub354 \ub192\uc740/\ub0ae\uc740 \ud574\uc0c1\ub3c4 (\ub354 \ud070/\uc791\uc740) \uc608\uce21 \ub9f5\uc744 \uc6d0\ud55c\ub2e4\uba74, \uc774 \ub9e4\uac1c\ubcc0\uc218\ub97c \uc801\uc808\ud788 \ubcc0\uacbd\ud574\uc57c \ud569\ub2c8\ub2e4. \uc608\uce21\uc774 \ubcd1\ud569\ub418\uba74 overlay_patch_prediction \ud568\uc218\ub97c \uc0ac\uc6a9\ud558\uc5ec \uc608\uce21 \ub9f5\uc744 WSI \uc378\ub124\uc77c\uc5d0 \uc624\ubc84\ub808\uc774\ud569\ub2c8\ub2e4. \uc774\ub54c \uc0ac\uc6a9\ub41c \ud574\uc0c1\ub3c4\ub294 \uc608\uce21 \ubcd1\ud569\uc5d0 \uc0ac\uc6a9\ub41c \ud574\uc0c1\ub3c4\uc640 \uc77c\uce58\ud574\uc57c\ud569\ub2c8\ub2e4. overview_resolution = ( 4 # \ud328\uce58 \uc608\uce21\uc744 \ubcd1\ud569\ud558\uace0 \uc2dc\uac01\ud654\ud558\ub294 \ud574\uc0c1\ub3c4 \uc124\uc815 ) # \u0027\ud574\uc0c1\ub3c4\u0027 \ub9e4\uac1c\ubcc0\uc218\uc758 \ub2e8\uc704 \uc124\uc815. \"power\", \"level\", \"mpp\", \ub610\ub294 \"baseline\" \uc911\uc5d0\uc11c \uc120\ud0dd \uac00\ub2a5 overview_unit = \"mpp\" wsi = WSIReader.open(wsi_path) wsi_overview = wsi.slide_thumbnail(resolution=overview_resolution, units=overview_unit) plt.figure(), plt.imshow(wsi_overview) plt.axis(\"off\") \uc608\uce21 \ub9f5\uc744 \uc774 \uc774\ubbf8\uc9c0\uc5d0 \uc624\ubc84\ub808\uc774\ud55c \uacb0\uacfc\ub294 \ub2e4\uc74c\uacfc \uac19\uc2b5\ub2c8\ub2e4: # \uc804\uccb4 \uc2ac\ub77c\uc774\ub4dc \uc774\ubbf8\uc9c0(Whole slide image)\uc758 \ud328\uce58 \ub808\ubca8 \uc608\uce21 \uc2dc\uac01\ud654 # \uba3c\uc800 \ub77c\ubca8 \uc0c9\uc0c1\uc758 \ub9e4\ud551 \uc124\uc815 label_color_dict = {} label_color_dict[0] = (\"empty\", (0, 0, 0)) colors = cm.get_cmap(\"Set1\").colors for class_name, label in label_dict.items(): label_color_dict[label + 1] = (class_name, 255 * np.array(colors[label])) pred_map = predictor.merge_predictions( wsi_path, wsi_output[0], resolution=overview_resolution, units=overview_unit, ) overlay = overlay_prediction_mask( wsi_overview, pred_map, alpha=0.5, label_info=label_color_dict, return_ax=True, ) plt.show() \ubcd1\ub9ac\ud559\uc5d0 \ud2b9\ud654\ub41c \ubaa8\ub378\uc744 \uc0ac\uc6a9\ud55c \ud2b9\uc9d5 \ucd94\ucd9c# \uc774 \ubd80\ubd84\uc5d0\uc11c\ub294 TIAToolbox \uc678\ubd80\uc5d0 \uc874\uc7ac\ud558\ub294 \uc0ac\uc804 \ud559\uc2b5\ub41c PyTorch \ubaa8\ub378\uc5d0\uc11c \ud2b9\uc9d5\uc744 \ucd94\ucd9c\ud558\ub294 \ubc29\ubc95\uc744 TIAToolbox\uc5d0\uc11c \uc81c\uacf5\ud558\ub294 WSI \ucd94\ub860 \uc5d4\uc9c4\uc744 \uc0ac\uc6a9\ud558\uc5ec \ubcf4\uc5ec\uc90d\ub2c8\ub2e4. \uc774\ub97c \uc124\uba85\ud558\uae30 \uc704\ud574, HistoEncoder\ub77c\ub294 \ubcd1\ub9ac\ud559\uc801 \uc774\ubbf8\uc9c0\uc5d0 \ud2b9\ud654\ub41c \ubaa8\ub378\uc744 \uc0ac\uc6a9\ud560 \uac83\uc785\ub2c8\ub2e4. HistoEncoder\ub294 \uc870\uc9c1\ud559 \uc774\ubbf8\uc9c0\uc5d0\uc11c \ud2b9\uc9d5\uc744 \ucd94\ucd9c\ud558\ub3c4\ub85d \uc790\uac00 \uc9c0\ub3c4 \ud559\uc2b5 \ubc29\uc2dd(self-supervised) \uc73c\ub85c \ud559\uc2b5\ub418\uc5c8\uc2b5\ub2c8\ub2e4. \uc774 \ubaa8\ub378\uc740 \ub2e4\uc74c\uc5d0\uc11c \uc0ac\uc6a9\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4: \u2018HistoEncoder: \ub514\uc9c0\ud138 \ubcd1\ub9ac\ud559\uc744 \uc704\ud55c \uae30\ubcf8 \ubaa8\ub378\u2019 (jopo666/HistoEncoder) \ud5ec\uc2f1\ud0a4 \ub300\ud559\uad50 Pohjonen, Joona \ud300. \ud2b9\uc9d5 \ub9f5\uc758 umap \ucc28\uc6d0 \ucd95\uc18c\ub97c 3D(RGB)\ub85c \uc2dc\uac01\ud654\ud558\uc5ec, \uc704\uc5d0\uc11c \uc5b8\uae09\ud55c \uc5ec\ub7ec \uc870\uc9c1 \uc720\ud615 \uac04\uc758 \ucc28\uc774\ub97c \ud2b9\uc9d5\ub4e4\uc774 \uc5b4\ub5bb\uac8c \ud3ec\ucc29\ud558\ub294\uc9c0 \ubcf4\uc5ec\uc904 \uac83\uc785\ub2c8\ub2e4. # \ucd94\uac00 module \uac00\uc838\uc624\uae30 import histoencoder.functional as F import torch.nn as nn from tiatoolbox.models.engine.semantic_segmentor import DeepFeatureExtractor, IOSegmentorConfig from tiatoolbox.models.models_abc import ModelABC import umap TIAToolbox\ub294 PyTorch\uc758 nn.Module \uc744 \uc0c1\uc18d\ud558\ub294 ModelABC \ud074\ub798\uc2a4\ub97c \uc815\uc758\ud558\uba70, \uc774\ub294 TIAToolbox\uc758 \ucd94\ub860 \uc5d4\uc9c4\uc5d0\uc11c \uc0ac\uc6a9\ub420 \ubaa8\ub378\uc758 \uad6c\uc870\ub97c \uaddc\uc815\ud569\ub2c8\ub2e4. \ud558\uc9c0\ub9cc histoencoder \ubaa8\ub378\uc740 \uc774 \uad6c\uc870\ub97c \ub530\ub974\uc9c0 \uc54a\uae30 \ub54c\ubb38\uc5d0, TIAToolbox \uc5d4\uc9c4\uc774 \uae30\ub300\ud558\ub294 \ucd9c\ub825\uacfc \uba54\uc18c\ub4dc\ub97c \uc81c\uacf5\ud558\ub294 \ud074\ub798\uc2a4\ub85c HistoEncoder\ub97c \ub798\ud551(wrap)\ud574\uc57c \ud569\ub2c8\ub2e4. class HistoEncWrapper(ModelABC): \"\"\"tiatoolbox\uc758 ModelABC \uc778\ud130\ud398\uc774\uc2a4\uc5d0 \ub9de\ucd98 HistoEncW\ubaa8\ub378\uc758 \ub808\ud37c \uc0dd\uc131\"\"\" def __init__(self: HistoEncWrapper, encoder) -\u003e None: super().__init__() self.feat_extract = encoder def forward(self: HistoEncWrapper, imgs: torch.Tensor) -\u003e torch.Tensor: \"\"\"\uc785\ub825 \ub370\uc774\ud130\ub97c \ubaa8\ub378\uc744 \ud1b5\ud574 \uc804\ub2ec Args: imgs (torch.Tensor): Model input. \"\"\" out = F.extract_features(self.feat_extract, imgs, num_blocks=2, avg_pool=True) return out @staticmethod def infer_batch( model: nn.Module, batch_data: torch.Tensor, *, on_gpu: bool, ) -\u003e list[np.ndarray]: \"\"\"\uc785\ub825 \ubc30\uce58\uc5d0 \ub300\ud55c \ucd94\ub860 \uc2e4\ud589 \uc21c\ubc29\ud5a5 \uc5f0\uc0b0\uacfc \uc785\ucd9c\ub825 \uc9d1\uacc4\ub97c \uc704\ud55c \ub85c\uc9c1\uc774 \ud3ec\ud568\ub418\uc5b4 \uc788\uc2b5\ub2c8\ub2e4. Args: model (nn.Module): \uc815\uc758\ub41c PyTorch \ubaa8\ub378. batch_data (torch.Tensor): `torch.utils.data.DataLoader`\uc5d0 \uc758\ud574 \uc0dd\uc131\ub41c \ub370\uc774\ud130\uc758 \ubc30\uce58(batch). on_gpu (bool): \ucd94\ub860 \uc5f0\uc0b0\uc744 GPU\uc5d0\uc11c \ud560 \uac83\uc778\uc9c0. \"\"\" img_patches_device = batch_data.to(\u0027cuda\u0027) if on_gpu else batch_data model.eval() # \uae30\uc6b8\uae30\ub97c \uacc4\uc0b0\ud558\uc9c0 \uc54a\uc74c(\ud6c8\ub828\uc774 \uc544\ub2d8) with torch.inference_mode(): output = model(img_patches_device) return [output.cpu().numpy()] \uc774\uc81c \ub798\ud37c(wrapper)\ub97c \ub9cc\ub4e4\uc5c8\uc73c\ub2c8, \ud2b9\uc9d5 \ucd94\ucd9c \ubaa8\ub378\uc744 \uc0dd\uc131\ud558\uace0 DeepFeatureExtractor \ub97c \uc778\uc2a4\ud134\uc2a4\ud654 \ud558\uc5ec \uc774 \ubaa8\ub378\uc744 WSI\uc5d0 \uc0ac\uc6a9\ud560 \uc218 \uc788\uac8c \ud569\ub2c8\ub2e4. \uc774\uc804\uc5d0 \uc0ac\uc6a9\ud588\ub358 \ub3d9\uc77c\ud55c WSI\ub97c \uc0ac\uc6a9\ud558\uc9c0\ub9cc, \uc774\ubc88\uc5d0\ub294 \uac01 \ud328\uce58\uc5d0 \ub300\ud55c \ub77c\ubca8\uc744 \uc608\uce21\ud558\ub294 \ub300\uc2e0 HistoEncoder \ubaa8\ub378\uc744 \uc0ac\uc6a9\ud558\uc5ec, WSI\uc758 \ud328\uce58\uc5d0\uc11c \ud2b9\uc9d5\uc744 \ucd94\ucd9c\ud560 \uac83\uc785\ub2c8\ub2e4. # \ubaa8\ub378 \ub9cc\ub4e4\uae30 encoder = F.create_encoder(\"prostate_medium\") model = HistoEncWrapper(encoder) # \uc804\ucc98\ub9ac \ud568\uc218 \uc124\uc815 norm=transforms.Normalize(mean=[0.662, 0.446, 0.605],std=[0.169, 0.190, 0.155]) trans = [ transforms.ToTensor(), norm, ] model.preproc_func = transforms.Compose(trans) wsi_ioconfig = IOSegmentorConfig( input_resolutions=[{\"units\": \"mpp\", \"resolution\": 0.5}], patch_input_shape=[224, 224], output_resolutions=[{\"units\": \"mpp\", \"resolution\": 0.5}], patch_output_shape=[224, 224], stride_shape=[224, 224], ) DeepFeatureExtractor \ub97c \uc0dd\uc131\ud560 \ub54c auto_generate_mask=True \uc778\uc218\ub97c \uc804\ub2ec\ud560 \uac83\uc785\ub2c8\ub2e4. \uc774\ub294 otsu \uc784\uacc4\uac12 \uc54c\uace0\ub9ac\uc998\uc744 \uc0ac\uc6a9\ud558\uc5ec \uc790\ub3d9\uc73c\ub85c \uc870\uc9c1 \uc601\uc5ed\uc758 \ub9c8\uc2a4\ud06c\ub97c \uc0dd\uc131\ud558\uc5ec, \ucd94\ucd9c\uae30\uac00 \uc870\uc9c1\uc774 \ud3ec\ud568\ub41c \ud328\uce58\uc5d0\ub9cc \ucc98\ub9ac\ud558\ub3c4\ub85d \ud569\ub2c8\ub2e4. # \ud2b9\uc9d5 \ucd94\ucd9c\uae30 \uc0dd\uc131 \ubc0f WSI\uc5d0\uc11c \uc2e4\ud589\ud558\uae30 extractor = DeepFeatureExtractor(model=model, auto_generate_mask=True, batch_size=32, num_loader_workers=4, num_postproc_workers=4) with suppress_console_output(): out = extractor.predict(imgs=[wsi_path], mode=\"wsi\", ioconfig=wsi_ioconfig, save_dir=global_save_dir / \"wsi_features\",) \uc774\ub7ec\ud55c \ud2b9\uc9d5\ub4e4\uc740 \ub2e4\uc6b4\uc2a4\ud2b8\ub9bc \ubaa8\ub378\uc744 \ud6c8\ub828\ud558\ub294 \ub370 \uc0ac\uc6a9\ud560 \uc218 \uc788\uc9c0\ub9cc, \uc5ec\uae30\uc11c\ub294 \ud2b9\uc9d5\uc774 \ubb34\uc5c7\uc744 \ub098\ud0c0\ub0b4\ub294\uc9c0 \uc9c1\uad00\uc801\uc73c\ub85c \uc774\ud574\ud558\uae30 \uc704\ud574 UMAP \ucc28\uc6d0 \ucd95\uc18c\ub97c \uc0ac\uc6a9\ud558\uc5ec \ud2b9\uc9d5\uc744 RGB \uacf5\uac04\uc5d0\uc11c \uc2dc\uac01\ud654\ud560 \uac83\uc785\ub2c8\ub2e4. \uc720\uc0ac\ud55c \uc0c9\uc0c1\uc73c\ub85c \ub77c\ubca8\ub9c1\ub41c \ud3ec\uc778\ud2b8\ub4e4\uc740 \ube44\uc2b7\ud55c \ud2b9\uc9d5\uc744 \uac00\uc9c0\uace0 \uc788\uc5b4\uc57c \ud558\ubbc0\ub85c, UMAP \ucd95\uc18c \uacb0\uacfc\ub97c WSI \uc378\ub124\uc77c\uc5d0 \uc624\ubc84\ub808\uc774\ud558\uc5ec \ud2b9\uc9d5\ub4e4\uc774 \uc11c\ub85c \ub2e4\ub978 \uc870\uc9c1 \uc601\uc5ed\uc73c\ub85c \uc790\uc5f0\uc2a4\ub7fd\uac8c \ubd84\ub9ac\ub418\ub294\uc9c0 \ud655\uc778\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc774\ud6c4, \uc704\uc5d0\uc11c \uc0dd\uc131\ud55c \ud328\uce58 \uc218\uc900\uc758 \uc608\uce21 \ub9f5\uacfc \ud568\uaed8 \uc774\ub97c \uc2dc\uac01\ud654\ud558\uc5ec, \ud2b9\uc9d5\uacfc \ud328\uce58 \uc218\uc900 \uc608\uce21 \uac04\uc758 \ucc28\uc774\ub97c \ube44\uad50\ud574\ubcf4\uaca0\uc2b5\ub2c8\ub2e4. # \uba3c\uc800, UMAP \ucd95\uc18c \uacc4\uc0b0\uc744 \uc704\ud55c \ud568\uc218 \uc815\uc758 def umap_reducer(x, dims=3, nns=10): \"\"\"\uc785\ub825 \ub370\uc774\ud130\uc758 UMAP \ucd95\uc18c\"\"\" reducer = umap.UMAP(n_neighbors=nns, n_components=dims, metric=\"manhattan\", spread=0.5, random_state=2) reduced = reducer.fit_transform(x) reduced -= reduced.min(axis=0) reduced /= reduced.max(axis=0) return reduced # \ud2b9\uc9d5 \ucd94\ucd9c\uae30\uc5d0\uc11c \ucd9c\ub825\ub41c \ud2b9\uc9d5 \ubd88\ub7ec\uc624\uae30 pos = np.load(global_save_dir / \"wsi_features\" / \"0.position.npy\") feats = np.load(global_save_dir / \"wsi_features\" / \"0.features.0.npy\") pos = pos / 8 # 0.5mpp\uc5d0\uc11c \ud2b9\uc9d5\uc744 \ucd94\ucd9c\ud558\uace0, 4mpp\uc5d0\uc11c \uc378\ub124\uc77c\uc5d0 \uc624\ubc84\ub808\uc774\ud558\uae30 # \ud2b9\uc9d5\uc744 3\ucc28\uc6d0(RGB) \uacf5\uac04\uc73c\ub85c \ucd95\uc18c\ud558\uae30 reduced = umap_reducer(feats) # \ubd84\ub958\uae30\uc758 \uc608\uce21 \ub9f5\uc744 \ub2e4\uc2dc \uadf8\ub9ac\uae30 overlay = overlay_prediction_mask( wsi_overview, pred_map, alpha=0.5, label_info=label_color_dict, return_ax=True, ) # \ud2b9\uc9d5 \ub9f5 \ucd95\uc18c\ub97c \uc2dc\uac01\ud654\ud558\uae30 plt.figure() plt.imshow(wsi_overview) plt.scatter(pos[:,0], pos[:,1], c=reduced, s=1, alpha=0.5) plt.axis(\"off\") plt.title(\"UMAP reduction of HistoEnc features\") plt.show() \ud328\uce58 \uc218\uc900 \uc608\uce21\uae30(patch-level predictor)\uc5d0\uc11c \uc0dd\uc131\ub41c \uc608\uce21 \ub9f5\uacfc \uc790\uac00 \uc9c0\ub3c4 \ud559\uc2b5(self-supervised) \uc778\ucf54\ub354\ub97c \ud1b5\ud574 \ud2b9\uc9d5\uc744 \ucd94\ucd9c\ud55c \ud2b9\uc9d5 \ub9f5\uc774 WSI\uc5d0\uc11c \uc870\uc9c1 \uc720\ud615\uc5d0 \ub300\ud55c \uc720\uc0ac\ud55c \uc815\ubcf4\ub97c \ud3ec\ucc29\ud558\uace0 \uc788\uc74c\uc744 \ud655\uc778\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc774\ub294 \ubaa8\ub378\uc774 \uc608\uc0c1\ub300\ub85c \uc791\ub3d9\ud558\uace0 \uc788\uc74c\uc744 \ud655\uc778\ud560 \uc218 \uc788\ub294 \uc88b\uc740 \uac80\uc99d \ubc29\ubc95\uc785\ub2c8\ub2e4. \ub610\ud55c, HistoEncoder \ubaa8\ub378\uc774 \ucd94\ucd9c\ud55c \ud2b9\uc9d5\ub4e4\uc774 \uc870\uc9c1 \uc720\ud615 \uac04\uc758 \ucc28\uc774\ub97c \uc798 \ud3ec\ucc29\ud558\uace0 \uc788\uc73c\uba70, \ub530\ub77c\uc11c \uc774 \ud2b9\uc9d5\ub4e4\uc774 \uc870\uc9c1\ud559\uc801\uc73c\ub85c \uc911\uc694\ud55c \uc815\ubcf4\ub97c \uc778\ucf54\ub529\ud558\uace0 \uc788\uc74c\uc744 \ubcf4\uc5ec\uc90d\ub2c8\ub2e4. \uc55e\uc73c\ub85c \ud574\uc57c\ud560 \uac83# \uc774 \ub178\ud2b8\ubd81\uc5d0\uc11c\ub294 PatchPredictor \uc640 DeepFeatureExtractor \ud074\ub798\uc2a4\uc758 predict \uba54\uc18c\ub4dc\ub97c \uc0ac\uc6a9\ud558\uc5ec \ud070 \ud0c0\uc77c(tiles)\uacfc WSI\uc758 \ud328\uce58\uc5d0 \ub300\ud574 \ub77c\ubca8\uc744 \uc608\uce21\ud558\uac70\ub098 \ud2b9\uc9d5\uc744 \ucd94\ucd9c\ud558\ub294 \ubc29\ubc95\uc744 \ubcf4\uc5ec\uc90d\ub2c8\ub2e4. \ub610\ud55c, \ud328\uce58 \uc608\uce21 \uacb0\uacfc\ub97c \ubcd1\ud569\ud558\uace0 \uc785\ub825 \uc774\ubbf8\uc9c0/WSI\uc5d0 \uc608\uce21 \ub9f5\uc744 \uc624\ubc84\ub808\uc774\ub85c \uc2dc\uac01\ud654\ud558\ub294 merge_predictions \uc640 overlay_prediction_mask \ubcf4\uc870 \ud568\uc218\ub3c4 \uc18c\uac1c\ud569\ub2c8\ub2e4. \ubaa8\ub4e0 \uacfc\uc815\uc740 TIAToolbox \ub0b4\uc5d0\uc11c \uc774\ub8e8\uc5b4\uc9c0\uba70, \uc608\uc81c \ucf54\ub4dc\ub97c \ub530\ub77c \uc27d\uac8c \uad6c\uc131\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc785\ub825\uac12\uacfc \uc635\uc158\uc744 \uc62c\ubc14\ub974\uac8c \uc124\uc815\ud558\ub294 \uac83\uc744 \uaf2d \ud655\uc778\ud558\uc138\uc694. \ub610\ud55c predict \ud568\uc218\uc758 \ub9e4\uac1c\ubcc0\uc218\ub97c \ubcc0\uacbd\ud588\uc744 \ub54c \uc608\uce21 \uacb0\uacfc\uc5d0 \ubbf8\uce58\ub294 \uc601\ud5a5\uc744 \ud0d0\uad6c\ud558\ub294 \uac83\ub3c4 \uad8c\uc7a5\ud569\ub2c8\ub2e4. TIAToolbox \ud504\ub808\uc784\uc6cc\ud06c\uc5d0\uc11c \uc81c\uacf5\ud558\ub294 \ucee4\ubba4\ub2c8\ud2f0\uc758 \ubaa8\ub378 \ub610\ub294 \uc0ac\uc6a9\uc790 \uc815\uc758 \uc0ac\uc804 \ud559\uc2b5\ub41c \ubaa8\ub378\uc744 \uc0ac\uc6a9\ud558\uc5ec, TIAToolbox \ubaa8\ub378 \ud074\ub798\uc2a4\uc5d0 \uc815\uc758\ub418\uc9c0 \uc54a\uc740 \uad6c\uc870\uc758 \ubaa8\ub378\uc774\ub77c\ub3c4 \ub300\ud615 WSI\uc5d0 \ub300\ud574 \ucd94\ub860\uc744 \uc218\ud589\ud558\ub294 \ubc29\ubc95\uc744 \uc2dc\uc5f0\ud588\uc2b5\ub2c8\ub2e4. \ub2e4\uc74c \uc790\ub8cc\ub97c \ud1b5\ud574 \ub354 \ub9ce\uc740 \ub0b4\uc6a9\uc744 \ubc30\uc6b8 \uc218 \uc788\uc2b5\ub2c8\ub2e4: PyTorch\uc640 TIAToolbox\ub97c \ud1b5\ud574 \uc219\ub828\ub41c \ubaa8\ub378 \ub2e4\ub8e8\uae30 \ucee4\uc2a4\ud140 PyTorch \uadf8\ub798\ud504 \uc2e0\uacbd\ub9dd\uc744 \uc0ac\uc6a9\ud558\uc5ec WSI(\uc804\uccb4 \uc2ac\ub77c\uc774\ub4dc \uc774\ubbf8\uc9c0)\uc5d0 \ub300\ud55c \uc2ac\ub77c\uc774\ub4dc \uadf8\ub798\ud504 \uc0dd\uc131\ud558\uae30",
       "author": {
         "@type": "Organization",
         "name": "PyTorch Contributors",
         "url": "https://pytorch.org"
       },
       "image": "../_static/img/pytorch_seo.png",
       "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "/intermediate/tiatoolbox_tutorial.html"
       },
       "datePublished": "2023-01-01T00:00:00Z",
       "dateModified": "2023-01-01T00:00:00Z"
     }
 </script>
  <script>
    // Tutorials Call to action event tracking
    $("[data-behavior='call-to-action-event']").on('click', function () {
      fbq('trackCustom', "Download", {
        tutorialTitle: $('h1:first').text(),
        downloadLink: this.href,
        tutorialLink: window.location.href,
        downloadTitle: $(this).attr("data-response")
      });
      if (typeof gtag === 'function') {
        gtag('event', 'click', {
          'event_category': $(this).attr("data-response"),
          'event_label': $("h1").first().text(),
          'tutorial_link': window.location.href
        });
      }
    });
  </script>
  
  </body>
</html>